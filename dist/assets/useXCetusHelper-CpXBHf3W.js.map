{"version":3,"file":"useXCetusHelper-CpXBHf3W.js","sources":["../../src/hooks/xcetus/useXCetusHelper.ts"],"sourcesContent":["import useXCetusStore from '@/store/xcetus/useXCetus'\nimport { XCetusRewardInfo } from '@/types/xcetus'\nimport { useGetToken } from '@cetus/hooks/src/useToken'\nimport useTokenPrice from '@cetus/hooks/src/useTokenPrice'\nimport { useAccountStore } from '@cetus/stores'\nimport useTokenPriceStore from '@cetus/stores/src/tokenPrice'\nimport usePeripherySDKStore from '@cetus/stores/src/usePeripherySDKStore'\nimport envConfigs from '@cetus/types/src/config/envConfigs'\nimport { d } from '@cetus/utils'\nimport { fixCoinType } from '@cetusprotocol/cetus-burn-sdk'\nimport { DividendReward, PhaseDividendInfo, XCetusUtil } from '@cetusprotocol/cetus-periphery-sdk'\nimport { fromDecimalsAmount } from '@cetusprotocol/cetus-sui-clmm-sdk'\nimport { DividendManager } from '@cetusprotocol/cetus-xcetus-sdk'\nimport { useCallback, useEffect, useState } from 'react'\n\n/**\n *  Ëé∑ÂèñÊàëÁöÑxcetus ËÆ¢Âçï\n * @returns\n */\nexport function useGetOwnerLockCetusList() {\n  const { xCetusSdk } = usePeripherySDKStore()\n  const { currentAccount } = useAccountStore()\n\n  const { setLockCetusListLoading, clearData, setLockCetusList } = useXCetusStore()\n\n  const fetchOwnerLockCetusList = async (address = currentAccount?.address) => {\n    if (!address) {\n      setLockCetusListLoading(false)\n      clearData()\n      return\n    }\n    setLockCetusListLoading(true)\n    try {\n      const lockList = await xCetusSdk.XCetusModule.getOwnerRedeemLockList(address)\n      console.log('üöÄ ~ fetchOwnerLockCetusList ~ lockList:', lockList, address)\n      if (address === currentAccount?.address) {\n        lockList.sort((a, b) => a.locked_until_time - b.locked_until_time)\n        setLockCetusList(lockList)\n      }\n    } catch (error) {\n      console.log('üöÄ ~ fetchOwnerLockCetusList ~ error:', error)\n    } finally {\n      setLockCetusListLoading(false)\n    }\n  }\n\n  return {\n    fetchOwnerLockCetusList\n  }\n}\n\n/**\n *  Ëé∑ÂèñÁî®Êà∑ÁöÑÂàÜÁ∫¢‰ø°ÊÅØ\n */\nexport function useGetVeNFTDividendInfo() {\n  const { xCetusSdk } = usePeripherySDKStore()\n\n  const { setDividendRewardList } = useXCetusStore()\n\n  const fetchVeNFTDividendInfo = async (veNftId: string) => {\n    try {\n      const dividendInfo = await xCetusSdk.XCetusModule.getVeNFTDividendInfo(veNftId)\n      console.log('üöÄ ~ file: useXCetusHelper.ts:62 ~ fetchVeNFTDividendInfo ~ dividendInfo:', dividendInfo)\n\n      if (dividendInfo) {\n        setDividendRewardList(dividendInfo.rewards)\n      }\n    } catch (error) {\n      console.log('üöÄ ~ fetchVeNFTDividendInfo ~ error:', error, veNftId)\n    }\n  }\n\n  return { fetchVeNFTDividendInfo }\n}\n\nexport function useGetOwnerVeNFT() {\n  const { xCetusSdk } = usePeripherySDKStore()\n  const { currentAccount } = useAccountStore()\n\n  const { setVeNFTLoading, clearData, setVeNFT } = useXCetusStore()\n\n  const fetchOwnerVeNFT = async (address = currentAccount?.address, forceRefresh?: boolean) => {\n    if (!address) {\n      setVeNFTLoading(false)\n      clearData()\n      return\n    }\n\n    setVeNFTLoading(true)\n\n    try {\n      const veNFT = await xCetusSdk.XCetusModule.getOwnerVeNFT(address, forceRefresh)\n      console.log('üöÄ ~ fetchOwnerVeNFT ~ veNFT:', veNFT)\n      if (veNFT) {\n        setVeNFT(veNFT, address)\n        return veNFT\n      }\n    } catch (error) {\n      console.log('üöÄ ~ fetchOwnerVeNFT ~ error:', error)\n    } finally {\n      setVeNFTLoading(false)\n    }\n  }\n\n  return { fetchOwnerVeNFT }\n}\n\n/**\n * Ëé∑ÂèñÂΩìÂâçÊúüÊï∞Âíå‰∏ã‰∏ÄÊúüÂºÄÂßãÊó∂Èó¥\n */\nexport function useGetCurrPeriod() {\n  const { dividendManager } = useXCetusStore()\n  const [currentPeriod, setCurrentPeriod] = useState<number | undefined>()\n  const [nextStartTime, setNextStartTime] = useState<number | undefined>()\n\n  const calculateCurrPeriod = (dividendManager: DividendManager) => {\n    const currentTime = Date.now() / 1000\n    const { start_time, interval_day } = dividendManager\n\n    const nextStartTime = Number(XCetusUtil.getNextStartTime(dividendManager).toString())\n\n    const currentPeriod =\n      envConfigs.env == 'testnet'\n        ? Math.ceil((currentTime - start_time) / (interval_day * 60))\n        : Math.ceil((currentTime - start_time) / (interval_day * 24 * 3600))\n\n    setCurrentPeriod(currentPeriod)\n    setNextStartTime(nextStartTime)\n  }\n\n  useEffect(() => {\n    if (dividendManager) {\n      calculateCurrPeriod(dividendManager)\n    }\n  }, [dividendManager])\n\n  return {\n    currentPeriod,\n    nextStartTime,\n    calculateCurrPeriod\n  }\n}\n\n/**\n * ËÆ°ÁÆóAPR\n */\nexport function useGetXCetusApr(phaseDividendInfo?: PhaseDividendInfo, treasury?: string) {\n  const { fetchTokenInfo } = useGetToken()\n  const { getTokenAmountValue } = useTokenPrice()\n  const { coinPriceObj } = useTokenPriceStore()\n  const [cetusApr, setCetusApr] = useState<string>('0')\n\n  const calculateAPR = useCallback(async () => {\n    if (!phaseDividendInfo || !treasury) return\n\n    try {\n      const bonusList = phaseDividendInfo.bonus\n\n      // Âπ∂Ë°åËé∑ÂèñÊâÄÊúâ‰ª£Â∏Å‰ø°ÊÅØÂíåÈáëÈ¢ù‰ª∑ÂÄº\n      const totalBonusAmountValue = await Promise.all(\n        bonusList.map(async bonus => {\n          const coinType = fixCoinType(bonus.name, false)\n          const coinInfo = await fetchTokenInfo(coinType)\n\n          if (coinInfo) {\n            const amount = fromDecimalsAmount(bonus.value, coinInfo.decimals).toString()\n            const value = getTokenAmountValue(coinType, amount)\n            // console.log('üöÄ ---------------------------------------------------------------üöÄ')\n            // console.log('üöÄ ~ file: useXCetusHelper.ts:158 ~ calculateAPR ~ value:', value, coinType)\n            // console.log('üöÄ ---------------------------------------------------------------üöÄ')\n\n            return value\n          }\n          return '0'\n        })\n      ).then(values => values.reduce((acc, value) => acc.add(value), d(0))) // Ê±áÊÄª‰ª∑ÂÄº\n\n      // Ëé∑Âèñ Cetus ÁöÑÊÄª‰ª∑ÂÄº\n      const cetusValue = getTokenAmountValue(envConfigs.cetus_coin.coin_type, fromDecimalsAmount(treasury, 9).toString())\n\n      // ËÆ°ÁÆó APR\n      const apr = d(cetusValue).gt(0) ? totalBonusAmountValue.div(7).mul(365).div(cetusValue).mul(100).toFixed(2) : '0'\n\n      setCetusApr(Number(apr) > 0 && Number(apr) < 0.01 ? '0.01' : apr.toString())\n    } catch (error) {\n      console.error('Error calculating APR:', error)\n      setCetusApr('0.01') // Â§ÑÁêÜÈîôËØØÊó∂ËÆæÁΩÆÈªòËÆ§ÂÄº\n    }\n  }, [phaseDividendInfo?.bonus, treasury, coinPriceObj])\n\n  useEffect(() => {\n    calculateAPR()\n  }, [phaseDividendInfo?.bonus, treasury, coinPriceObj])\n\n  return { cetusApr }\n}\n\n/**\n * Ëé∑ÂèñÁî®Êà∑ÁöÑÂ•ñÂä±‰ø°ÊÅØ\n */\nexport function useGetUserRewards(currentPeriod?: number) {\n  const { dividendRewardList } = useXCetusStore()\n  const { fetchTokenInfo } = useGetToken()\n  const { getTokenAmountValue } = useTokenPrice()\n  const [summaryRewardList, setSummaryRewardList] = useState<XCetusRewardInfo[]>([])\n  const [rewardList, setRewardList] = useState<DividendReward[]>([])\n  const [totalRewardValue, setTotalRewardValue] = useState<string>('0')\n\n  const calculateRewards = useCallback(async () => {\n    let totalValue = d(0)\n\n    // ËøáÊª§ÊéâÂ•ñÂä±ÂÖ®‰∏∫0ÁöÑ Âíå  ÂΩìÊúüÁöÑÂ•ñÂä±\n    const filteredList = dividendRewardList.filter(item => {\n      if (item.period === currentPeriod) {\n        return false\n      }\n      if (item.rewards.find(reward => d(reward.amount).eq(0))) {\n        return false\n      }\n      return true\n    })\n\n    console.log('üöÄ ~ file: useXCetusHelper.ts:107 ~ calculateRewards ~ filteredList:', {\n      filteredList,\n      dividendRewardList,\n      currentPeriod\n    })\n\n    setRewardList(filteredList)\n\n    const rewardMap: Record<string, XCetusRewardInfo> = {}\n\n    await Promise.all(\n      filteredList.map(async item => {\n        for (const reward of item.rewards) {\n          const coinType = fixCoinType(reward.coin_type, false)\n          const coinInfo = await fetchTokenInfo(coinType)\n          if (coinInfo) {\n            const amount = fromDecimalsAmount(reward.amount, coinInfo.decimals).toString()\n\n            const amountValue = getTokenAmountValue(coinType, amount)\n            // console.log('üöÄ -------------------------------------------------------------------------------üöÄ')\n            // console.log('üöÄ ~ file: useXCetusHelper.ts:213 ~ calculateRewards ~ amountValue:', amountValue, coinType)\n            // console.log('üöÄ -------------------------------------------------------------------------------üöÄ')\n\n            totalValue = totalValue.add(amountValue)\n\n            // Êõ¥Êñ∞ rewardMap\n            rewardMap[coinType] = rewardMap[coinType]\n              ? {\n                  ...rewardMap[coinType],\n                  amount: d(rewardMap[coinType].amount).add(amount).toString(),\n                  value: d(rewardMap[coinType].value).add(amountValue).toString()\n                }\n              : {\n                  amount,\n                  coin_type: coinType,\n                  value: amountValue\n                }\n          }\n        }\n      })\n    )\n    setSummaryRewardList(\n      Object.values(rewardMap)\n        .filter(item => d(item.amount).gt(0))\n        .sort((a, b) => d(b.value).sub(a.value).toNumber())\n    )\n    setTotalRewardValue(totalValue.toString())\n  }, [dividendRewardList, fetchTokenInfo, getTokenAmountValue, currentPeriod])\n\n  useEffect(() => {\n    if (currentPeriod) {\n      calculateRewards()\n    }\n  }, [dividendRewardList, currentPeriod])\n\n  return {\n    summaryRewardList,\n    rewardList,\n    totalRewardValue\n  }\n}\n"],"names":["useGetOwnerLockCetusList","xCetusSdk","usePeripherySDKStore","currentAccount","useAccountStore","setLockCetusListLoading","clearData","setLockCetusList","useXCetusStore","address","lockList","a","b","error","useGetVeNFTDividendInfo","setDividendRewardList","veNftId","dividendInfo","useGetOwnerVeNFT","setVeNFTLoading","setVeNFT","forceRefresh","veNFT","useGetCurrPeriod","dividendManager","currentPeriod","setCurrentPeriod","useState","nextStartTime","setNextStartTime","calculateCurrPeriod","currentTime","start_time","interval_day","XCetusUtil","envConfigs","useEffect","useGetXCetusApr","phaseDividendInfo","treasury","fetchTokenInfo","useGetToken","getTokenAmountValue","useTokenPrice","coinPriceObj","useTokenPriceStore","cetusApr","setCetusApr","calculateAPR","useCallback","bonusList","totalBonusAmountValue","bonus","coinType","fixCoinType","coinInfo","amount","fromDecimalsAmount","values","acc","value","d","cetusValue","apr","useGetUserRewards","dividendRewardList","summaryRewardList","setSummaryRewardList","rewardList","setRewardList","totalRewardValue","setTotalRewardValue","calculateRewards","totalValue","filteredList","item","reward","rewardMap","amountValue"],"mappings":"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"}