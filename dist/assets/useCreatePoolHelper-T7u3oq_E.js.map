{"version":3,"file":"useCreatePoolHelper-T7u3oq_E.js","sources":["../../src/hooks/create-pool/useCreatePoolHelper.ts"],"sourcesContent":["import usePosAdd from '@/hooks/position/usePosAdd'\nimport { preCreateRes } from '@/types'\nimport { getFeeTierList } from '@/utils/liquidity'\nimport { getReversePrice } from '@/utils/pool'\nimport { defaultFeeList, FeeTier } from '@cetus/design/src/components/common/FeeTierSelect'\nimport { useSdk } from '@cetus/sdk-factory'\nimport { Token } from '@cetus/types'\nimport { amountToBN, d } from '@cetus/utils'\nimport { getNearestTickByTick, TickMath, TickUtil } from '@cetusprotocol/common-sdk'\nimport { useMemo } from 'react'\nimport useGetPoolList from '../pool/useGetPoolList'\n\nexport default function useCreatePoolHelper() {\n  const clmmSdk = useSdk('clmm')\n  const { preAdd } = usePosAdd()\n  const { getPoolList } = useGetPoolList()\n\n  const slippage = 0.05\n\n  /**\n   * 获取fee tier list\n   * @param baseCoinType\n   * @param quoteCoinType\n   * @returns\n   */\n  const fetchFeeTierList = async (baseCoinType: string, quoteCoinType: string) => {\n    try {\n      if (baseCoinType && quoteCoinType) {\n        const res = await getPoolList({\n          coin_type: `${baseCoinType},${quoteCoinType}`,\n          is_vaults: false,\n          display_all_pools: true,\n          has_mining: true,\n          has_farming: true,\n          no_incentives: true,\n          order_by: '-vol',\n          offset: 0\n        })\n        if (res && res.list && res.list.length > 0) {\n          const feeTierList = getFeeTierList(res.list) as FeeTier[]\n          const result = defaultFeeList?.map(item => {\n            const _pool = feeTierList.find(feeTier => feeTier.feeRate === item.feeRate)\n            return {\n              ...item,\n              title: _pool?.title || item.title,\n              poolAddress: _pool?.poolAddress,\n              liquidity: _pool?.liquidity,\n              tvl: _pool?.tvl\n            }\n          })\n\n          const feeIndex = result.findIndex((ele: any) => ele.feeDisplay === '0.001%' && !ele.poolAddress)\n          return result.filter((ele, index) => Number(index) !== feeIndex)\n        } else {\n          return defaultFeeList.filter(ele => ele.feeDisplay !== '0.001%')\n        }\n      }\n    } catch (error) {\n      console.log('🚀 ~ fetchFeeTierList ~ fetchFeeTierList:', error)\n    }\n    return [...defaultFeeList]\n  }\n\n  // 创建池子预计算\n  const preAddPool = (params: {\n    realTokenA: Token\n    realTokenB: Token\n    needReverse: boolean\n    price: string\n    tickSpacing: number\n    minPrice: string\n    maxPrice: string\n    amount: string\n    amountCoinType: string\n  }): preCreateRes => {\n    const { tickSpacing, price, minPrice, maxPrice, amount, amountCoinType, realTokenA, realTokenB, needReverse } = params\n    const currentSqrtPrice = TickMath.priceToSqrtPriceX64(d(price), realTokenA.decimals, realTokenB.decimals).toString()\n\n    const currTick = TickMath.priceToTickIndex(d(price), realTokenA.decimals, realTokenB.decimals).toString()\n\n    const decimalsA = realTokenA.decimals\n    const decimalsB = realTokenB.decimals\n\n    let lowerTick, upperTick\n    if (minPrice === '0' && maxPrice === '∞') {\n      lowerTick = TickUtil.getMinIndex(tickSpacing)\n      upperTick = TickUtil.getMaxIndex(tickSpacing)\n    } else {\n      const min = !needReverse ? minPrice : getReversePrice(maxPrice)\n      const max = !needReverse ? maxPrice : getReversePrice(minPrice)\n      const realMintTick = TickMath.priceToTickIndex(d(min), realTokenA.decimals, realTokenB.decimals).toString()\n      console.log('🚀 ~ file: useCreatePoolHelper.ts:103 ~ useCreatePoolHelper ~ realMintTick:', realMintTick)\n\n      lowerTick = getNearestTickByTick(TickMath.priceToTickIndex(d(min), decimalsA, decimalsB), tickSpacing)\n      upperTick = getNearestTickByTick(TickMath.priceToTickIndex(d(max), decimalsA, decimalsB), tickSpacing)\n    }\n\n    console.log('🚀 ~ file: useCreatePoolHelper.ts:87 ~ useCreatePoolHelper ~ params:', {\n      ...params,\n      currentSqrtPrice,\n      lowerTick,\n      upperTick,\n      currTick\n    })\n\n    const isTokenA = amountCoinType === realTokenA?.coin_type\n    const amountBN = amountToBN(amount, isTokenA ? decimalsA : decimalsB).toString()\n    const res = preAdd({\n      amount: amountBN,\n      tokenA: realTokenA,\n      tokenB: realTokenB,\n      isTokenA,\n      lowerTick,\n      upperTick,\n      curSqrtPrice: currentSqrtPrice,\n      isReverse: needReverse,\n      roundUp: true\n    })\n    console.log('🚀 -----------------------------------------------------------------------🚀')\n    console.log('🚀 ~ file: useCreatePoolHelper.ts:128 ~ useCreatePoolHelper ~ res:', res)\n    console.log('🚀 -----------------------------------------------------------------------🚀')\n\n    return {\n      ...res,\n      currentSqrtPrice,\n      fixAmountA: isTokenA,\n      lowerTick,\n      upperTick,\n      tickSpacing,\n      coinTypeA: realTokenA.coin_type,\n      coinTypeB: realTokenB.coin_type\n    }\n  }\n\n  /**\n   * 获取创建池子tx\n   * @param params\n   * @returns\n   */\n  const getCreatePoolTxPayload = async (params: preCreateRes) => {\n    console.log('🚀 ~ file: useCreatePoolHelper.ts:140 ~ getCreatePoolTxPayload ~ params:', params)\n    const { tickSpacing, currentSqrtPrice, fixAmountA, coinAmountAOrigin, coinAmountBOrigin, lowerTick, upperTick, coinTypeA, coinTypeB } = params\n\n    const metaDataA: any = await clmmSdk!.FullClient.getCoinMetadata({ coinType: coinTypeA })\n    const metaDataB: any = await clmmSdk!.FullClient.getCoinMetadata({ coinType: coinTypeB })\n\n    const tx = await clmmSdk!.Pool.createPoolPayload({\n      tick_spacing: tickSpacing,\n      initialize_sqrt_price: currentSqrtPrice,\n      uri: '',\n      fix_amount_a: fixAmountA,\n      amount_a: coinAmountAOrigin,\n      amount_b: coinAmountBOrigin,\n      tick_lower: lowerTick,\n      tick_upper: upperTick,\n      coin_type_a: coinTypeA,\n      coin_type_b: coinTypeB,\n      metadata_a: metaDataA?.id,\n      metadata_b: metaDataB?.id\n    })\n\n    return tx\n  }\n\n  return {\n    preAddPool,\n    fetchFeeTierList,\n    getCreatePoolTxPayload\n  }\n}\n\nexport function useShowPriceWarn(isFull: boolean, currTick?: number, minTick?: number, maxTick?: number) {\n  const showInputPriceWarn = useMemo(() => {\n    if (isFull) {\n      return false\n    }\n    try {\n      if (currTick !== undefined && minTick !== undefined && maxTick !== undefined) {\n        return d(currTick).lt(minTick) || d(currTick).gt(maxTick)\n      }\n    } catch (error) {\n      //\n    }\n\n    return false\n  }, [maxTick, currTick, minTick, isFull])\n\n  const showPriceRangeWarn = useMemo(() => {\n    if (isFull) {\n      return false\n    }\n    try {\n      if (minTick !== undefined && maxTick !== undefined) {\n        return d(minTick).gt(maxTick)\n      }\n    } catch (error) {\n      //\n    }\n\n    return false\n  }, [maxTick, minTick, isFull])\n\n  return {\n    showInputPriceWarn,\n    showPriceRangeWarn\n  }\n}\n"],"names":["useCreatePoolHelper","clmmSdk","useSdk","preAdd","usePosAdd","getPoolList","useGetPoolList","params","tickSpacing","price","minPrice","maxPrice","amount","amountCoinType","realTokenA","realTokenB","needReverse","currentSqrtPrice","TickMath","d","currTick","decimalsA","decimalsB","lowerTick","upperTick","TickUtil","min","getReversePrice","max","realMintTick","getNearestTickByTick","isTokenA","amountBN","amountToBN","res","baseCoinType","quoteCoinType","feeTierList","getFeeTierList","result","_a","defaultFeeList","item","_pool","feeTier","feeIndex","ele","index","error","fixAmountA","coinAmountAOrigin","coinAmountBOrigin","coinTypeA","coinTypeB","metaDataA","metaDataB","useShowPriceWarn","isFull","minTick","maxTick","showInputPriceWarn","useMemo","showPriceRangeWarn"],"mappings":"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"}