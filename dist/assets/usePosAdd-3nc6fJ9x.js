import{u as ht}from"./global-DLT0J0mI.js";import{c as vt}from"./usePositionList-jMKEHL_-.js";import{a as $t,u as Rt}from"./useCurrentPos-Bg9_OBWV.js";import{M as V}from"./msafe-oYBkW7LJ.js";import{u as Et}from"./useAccountBalance-CZOHOa8D.js";import{aI as Ot,R as Nt,a5 as Gt,r as y,a8 as Ut,a1 as Vt,d as D,as as at,bg as Q,bh as Kt,X as h,aP as jt,aR as Ht,a7 as Wt,aS as dt}from"./index-c8x0neDx.js";import{u as ct}from"./useTokenBalance-eq1GEE9D.js";import{u as Xt}from"./useTransaction-DAoWoqXP.js";import{u as zt}from"./useInsufficientBalanceToast-CiJ4SaVO.js";import{v as rt}from"./index-9_VNld9X.js";function de(){const{clmmSdk:lt}=Ot(),{peripherySdk:Y}=Nt(),{currentPosBaseInfo:t,posPoolsOriginalData:Jt,posPoolsRelatedData:Qt,posRewardsData:mt}=vt(),Z=mt[t==null?void 0:t.posId],{getTokenAmountValue:P}=Gt(),{getCurrentPosBaseInfo:ut,getCurrentPosHistory:Yt}=$t(),{currentPoolSqrtPrice:B,tokenAmountA:g,tokenAmountB:T,isFixedDisplayTokenA:q,setIsFixedDisplayTokenA:pt,setTokenAmountA:R,setTokenAmountB:E,curPosContractPoolInfo:c}=Rt(),[At,K]=y.useState(!1),[gt,Tt]=y.useState(""),[kt,xt]=y.useState(""),s=t==null?void 0:t.displayTokenA,n=t==null?void 0:t.displayTokenB,{slippage:O,mevProtect:St,maxCapForGas:yt,transactionMode:bt,customGasPrice:wt}=ht(),{balanceInfo:v}=ct(s),{balanceInfo:$}=ct(n),_t=P(s==null?void 0:s.coin_type,g),ft=P(n==null?void 0:n.coin_type,T),[j,H]=y.useState(""),I=y.useRef("");y.useEffect(()=>{console.log("ðŸš€ ~ usePosAdd ~ uuid:",j),I.current=j},[j]);const N=()=>{R(""),E(""),K(!1),H("")},G=y.useMemo(()=>{if(console.log("ðŸš€ ~ showTokenALock ~ curPosContractPoolInfo:",t,c),t&&c){const{lowerTick:e,upperTick:o}=t,i=c==null?void 0:c.current_tick_index;if(i!==void 0&&e!==void 0&&o!==void 0)return i>=e&&i<o?!1:i>=o?!0:!(i<e)}return!1},[c==null?void 0:c.current_tick_index,t]),U=y.useMemo(()=>{if(t&&c){const{lowerTick:e,upperTick:o}=t,i=c==null?void 0:c.current_tick_index;if(i!==void 0&&e!==void 0&&o!==void 0)return i>=e&&i<o||i>=o?!1:(i<e,!0)}return!1},[c==null?void 0:c.current_tick_index,t]),L=t!=null&&t.isReverse?U:G,F=t!=null&&t.isReverse?G:U,tt=e=>{console.log("ðŸš€ ~ usePosAdd ~ params:",e);const{amount:o,tokenA:i,tokenB:S,isTokenA:u,lowerTick:p,upperTick:k,curSqrtPrice:x,isReverse:l,roundUp:b}=e,w=new Q(o);console.log("ðŸš€ ~ usePosAdd ~ coinAmount:",O,x,w.toString());const{coinAmountA:a,coinAmountB:d,tokenMaxA:_,tokenMaxB:f,liquidityAmount:A}=Kt.estLiquidityAndcoinAmountFromOneAmounts(p,k,w,u,b,D(O).toNumber(),new Q(x));console.log("ðŸš€ ~ usePosAdd ~ coinAmountA:",a.toString()),console.log("ðŸš€ ~ usePosAdd ~ coinAmountB:",d.toString());const r=i.decimals,m=S.decimals;return{coinAmountAOrigin:a.toString(),coinAmountBOrigin:d.toString(),displayCoinAmountA:l?h(d.toString(),m):h(a.toString(),r),displayCoinAmountB:l?h(a.toString(),r):h(d.toString(),m),coinAmountA:h(a.toString(),r),coinAmountB:h(d.toString(),m),tokenMaxA:_.toString(),tokenMaxB:f.toString(),liquidityAmount:A.toString()}},et=Ut((e,o,i)=>{var A,r;const S=o?(A=t==null?void 0:t.displayTokenA)==null?void 0:A.decimals:(r=t==null?void 0:t.displayTokenB)==null?void 0:r.decimals,u=jt(e,S),p=t==null?void 0:t.tokenA,k=t==null?void 0:t.tokenB,x=t==null?void 0:t.lowerTick,l=t==null?void 0:t.upperTick,b=t==null?void 0:t.isReverse,w={amount:u,tokenA:p,tokenB:k,isTokenA:b?!o:o,lowerTick:x,upperTick:l,curSqrtPrice:B,isReverse:b,roundUp:!0};console.log("ðŸš€ ~ debouncedPreAdd ~ params:",w);const{displayCoinAmountA:a,displayCoinAmountB:d,tokenMaxA:_,tokenMaxB:f}=tt(w);I.current===i?(Tt(_),xt(f),o?E(d||""):R(a||"")):N(),K(!1)},500),W=()=>{if(g&&T&&Ht(t)){console.log("ðŸš€ ~ reCalculateResult ~ currentPosBaseInfo:",t);const e=q?g:T;if(+e){const o=rt();H(o),et(e,q,o)}}};y.useEffect(()=>{W()},[t]);const Mt=(e,o)=>{if(console.log("ðŸš€ ~ handleAmountChange ~ amount:",!e,+e,e),!e){N();return}if(pt(o),o?R(e):E(e),+e){K(!0);const i=rt();H(i),console.log("ðŸš€ ~ handleAmountChange ~ params:",e),et(e,o,i)}else o?E(""):R("")},ot=async e=>{const{poolAddress:o,coinTypeA:i,coinTypeB:S,fixAmountA:u,amountA:p,amountB:k,lowerTick:x,upperTick:l,currentSqrtPrice:b,posType:w,rewarderCoinTypes:a,posIndex:d,posId:_,farmsPoolId:f}=e,A={coinTypeA:i,coinTypeB:S,amount_a:p,amount_b:k,pool_id:o,fix_amount_a:u,slippage:D(O).toNumber(),is_open:!d,tick_lower:x,tick_upper:l,collect_fee:!!d,rewarder_coin_types:a,pos_id:_||""},r={slippage:D(O).toNumber(),curSqrtPrice:new Q(b)},m=await lt.Position.createAddLiquidityFixTokenPayload(A,r),C={action:d?V.IncreaseLiquidity:V.OpenAndAddLiquidity,txbParams:{parameter:A,gasEstimateArg:r}};return console.log("ðŸš€ ~ getClmmCreateAddData ~ msafeParams:",C,m),{tx:m,msafeParams:C}},it=async e=>{const{poolAddress:o,coinTypeA:i,coinTypeB:S,fixAmountA:u,amountA:p,amountB:k,lowerTick:x,upperTick:l,currentSqrtPrice:b,posType:w,rewarderCoinTypes:a,posIndex:d,posId:_,farmsPoolId:f}=e;let A,r;if(_){const m={pool_id:f||"",coinTypeA:i,coinTypeB:S,position_nft_id:_,clmm_pool_id:o,amount_a:p,amount_b:k,collect_fee:!0,collect_rewarder:!1,fix_amount_a:u,clmm_rewarder_types:a};A=await Y.Farms.addLiquidityFixCoinPayload(m),r={action:V.FarmingIncreaseLiquidity,txbParams:m}}else{const m={pool_id:f||"",coinTypeA:i,coinTypeB:S,clmm_pool_id:o,amount_a:p,amount_b:k,fix_amount_a:u,tick_lower:x,tick_upper:l};A=await Y.Farms.openPositionAddLiquidityStakePaylod(m),r={action:V.FarmingOpenAndAddLiquidity,txbParams:m}}return console.log("ðŸš€ ~ getFarmsCreateAddData ~ msafeParams:",r,A),{tx:A,msafeParams:r}},st=e=>{const{posType:o}=e;return o==="clmm"?ot(e):it(e)},{currentAccount:M}=Vt(),Ct=y.useMemo(()=>{const e={text:"Add More Liquidity",disabled:!1};return M!=null&&M.address?!+g&&!+T?(e.text="Enter an amount",e.disabled=!0,e):!L&&g&&D(g).gt((v==null?void 0:v.balanceFormat)||0)?(e.disabled=!0,e.text=`Insufficient ${at(s==null?void 0:s.symbol,10)} Balance`,e):!F&&T&&D(T).gt(($==null?void 0:$.balanceFormat)||0)?(e.disabled=!0,e.text=`Insufficient ${at(n==null?void 0:n.symbol,10)} Balance`,e):((!G&&!U&&(!+g||!+T)||(t==null?void 0:t.posType)=="burn")&&(e.disabled=!0),e):(e.text="Connect Wallet",e.disabled=!1,e)},[g,T,v,$,M==null?void 0:M.address]),{signAndExecuteTransaction:Dt}=Xt(),[qt,X]=y.useState(!1),{fetchAccountBalance:Lt}=Et(),{showInsufficientBalanceToast:Ft}=zt();return{preAddLoading:At,preAdd:tt,getAddTsPayload:st,displayTokenA:s,displayTokenB:n,tokenABalanceInfo:v,tokenBBalanceInfo:$,tokenAmountValueA:_t,tokenAmountValueB:ft,handleAmountChange:Mt,resetInputAmount:N,btnStatusText:Ct,toAdd:async()=>{var w;X(!0);const e=q?g:T,o=q?s.decimals:n.decimals,i=D(e).mul(Wt.pow(10,o)).toString(),S=t!=null&&t.isReverse?!q:q;let u,p;const k=t==null?void 0:t.lowerTick,x=t==null?void 0:t.upperTick,l=c==null?void 0:c.current_tick_index;l!==void 0&&k&&x&&(l>=k&&l<=x?(u=S?i:gt,p=S?kt:i):l>x?(u=0,p=i):l<k&&(u=i,p=0)),console.log("ðŸš€ ~ toAdd ~ lowerTick:",k,x,l),console.log("ðŸš€ ~ toAdd ~ amount_a:",t,u,p);const b=(w=Z||[])==null?void 0:w.reduce((a,d)=>(D(d==null?void 0:d.amount_owed).gt(0)&&a.push(d.coin_address),a),[]);console.log("ðŸš€ ~ toAdd ~ rewarderCoinTypes:",Z,b);try{const a={poolAddress:t==null?void 0:t.clmmPool,coinTypeA:t==null?void 0:t.coinTypeA,coinTypeB:t==null?void 0:t.coinTypeB,amountA:u,amountB:p,fixAmountA:S,lowerTick:t==null?void 0:t.lowerTick,upperTick:t==null?void 0:t.upperTick,currentSqrtPrice:B,posType:t==null?void 0:t.posType,rewarderCoinTypes:b,posIndex:t==null?void 0:t.index,posId:(t==null?void 0:t.posType)=="farms"?t==null?void 0:t.id:t==null?void 0:t.posId};(t==null?void 0:t.posType)=="farms"&&(a.farmsPoolId=t==null?void 0:t.farmsPool),console.log("ðŸš€ ~ toAdd ~ params:",a);const{tx:d,msafeParams:_}=await st(a),f=await Dt(d,{getShowInfo:(A,r)=>{const m=!L&&!F?`Add ${g} ${s==null?void 0:s.symbol} and ${T} ${n==null?void 0:n.symbol}`:L?F?"Add Liquidity":`Add ${T} ${n==null?void 0:n.symbol}`:`Add ${g} ${s==null?void 0:s.symbol}`,C={modalDescriptionText:m,toastTitleText:m};if(A==="success"){let z=g,J=T;r&&(z=dt(r,s)||g,J=dt(r,n)||T);const nt=!L&&!F?`Add ${z} ${s==null?void 0:s.symbol} and ${J} ${n==null?void 0:n.symbol}`:L?F?"Add Liquidity":`Add ${J} ${n==null?void 0:n.symbol}`:`Add ${z} ${s==null?void 0:s.symbol}`;C.toastDescriptionContent=nt,C.modalDescriptionText=nt,C.toastTitleText="Supplied Successful"}return C}},{useMev:St,useFastMode:bt==="Fast Mode",maxCapForGas:yt,customGasPrice:wt,msafeParams:_});console.log("ðŸš€ ~ toClaim ~ res:",f),f?(Lt(),N(),ut(M==null?void 0:M.address,t==null?void 0:t.id,!0)):W(),X(!1)}catch(a){console.log("ðŸš€ ~ toClaim ~ error:",a),W(),Ft(String(a)),X(!1)}},isAddLoading:qt,showTokenALock:G,showTokenBLock:U,showDisplayTokenALock:L,showDisplayTokenBLock:F,getClmmCreateAddData:ot,getFarmsCreateAddData:it}}export{de as u};
