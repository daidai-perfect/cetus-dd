import{r as _,aR as m,a_ as b,aK as K,b0 as k,a7 as H,be as P,aA as w}from"./index-BB14M7zw.js";import{u as N}from"./useToken-BjRHcKk_.js";import{u as G}from"./global-XupHuE_W.js";import{u as $}from"./useGetPoolList-DiqtR684.js";var E=(t=>(t.CETUS="CETUS",t.KRIYA="KRIYA",t.KRIYAV3="KRIYAV3",t.FLOWX="FLOWX",t.FLOWXV3="FLOWXV3",t.AFTERMATH="AFTERMATH",t.METASTABLE="METASTABLE",t.HAEDAL="HAEDAL",t.VOLO="VOLO",t.AFSUI="AFSUI",t.DEEPBOOKV3="DEEPBOOKV3",t.SCALLOP="SCALLOP",t.BLUEMOVE="BLUEMOVE",t.TURBOS="TURBOS",t.SPRINGSUI="SPRINGSUI",t.BLUEFIN="BLUEFIN",t.HAEDALPMM="HAEDALPMM",t.ALPHAFI="ALPHAFI",t.STEAMM="STEAMM",t.OBRIC="OBRIC",t))(E||{}),F=(t=>(t[t.CalculateError=1e4]="CalculateError",t[t.NumberTooLarge=10001]="NumberTooLarge",t[t.NoRouter=10002]="NoRouter",t[t.InsufficientLiquidity=10003]="InsufficientLiquidity",t[t.HoneyPot=10004]="HoneyPot",t))(F||{}),x=(t=>(t.TradeInputPage="TradeInput",t.TradeStatus="TradeStatus",t.SelectTokenPage="SelectToken",t.TradeConfirmPage="TradeConfirm",t.RoutePage="Route",t.TradeSetting="TradeSetting",t.SlippageSetting="SlippageSetting",t))(x||{});function C(t=!0){const{poolApiMap:n,setPoolApiMap:d}=G(),{getPoolList:p,getLocalJsonPoolList:y,getLocalJsonPoolAddress:A}=$();return{getPoolListByCoinType:async(l,u)=>{if(l&&u){const s=[l,u].sort(),e=`${s[0]}_${s[1]}`,f=n[e];if(f)return f;const a={coin_type:`${l},${u}`,display_all_pools:!0,offset:0,limit:100,order_by:"-tvl",no_incentives:!0,has_farming:!0,has_mining:!0};let o=t?await y(a):void 0;(o===void 0||o.list.length===0)&&(o=await p(a));const i=o.list;if(i.length>0)return n[e]=i,d(e,i),i}return[]},getPoolAddressByCoinType:async(l,u)=>{if(l&&u){const s=[l,u].sort(),e=`${s[0]}_${s[1]}`;if(t){const o=await A(l,u);if(!o||o.length===0){const i=n[e];if(i)return i.map(c=>c.poolAddress)}else return o}const f={coin_type:`${l},${u}`,display_all_pools:!0,offset:0,limit:100,order_by:"-tvl",no_incentives:!0,has_farming:!0,has_mining:!0},a=await p(f);if(a){const o=a.list;if(o.length>0)return n[e]=o,d(e,o),o.map(i=>i.poolAddress)}}return[]}}}function J(t,n){return{priceAcceptRouterData:_.useMemo(()=>{if(n&&t){if(t.byAmountIn){if(!m(t.toAmountUi).eq(n.toAmountUi||"0"))return n}else if(!m(t.fromAmountUi).eq(n.fromAmountUi||"0"))return n;return}},[n,t])}}function j(t,n){return{amountLimit:_.useMemo(()=>{if(n&&n.routerData){const{byAmountIn:p,fromAmountUi:y,toAmountUi:A}=n;return p?m(A).mul(m(1).sub(m(t))).toString():m(y).mul(m(1).add(m(t))).toString()}},[t,n])}}function W(t){const{fetchTokenInfo:n}=N(),[d,p]=_.useState({}),y=async()=>{var A,I,R;if(t&&t.routerData){const l=[],u=t.byAmountIn?t.routerData.amountIn.toString():t.routerData.amountOut.toString(),s=[],e=[];let f=m(0);const a=((A=t==null?void 0:t.routerData)==null?void 0:A.routes)||[];for(let i=0;i<a.length;i++){const c=a[i],r={},T=t.byAmountIn?c.amountIn.toString():c.amountOut.toString();i===t.routerData.routes.length-1?r.percentage=m(1).sub(f).toFixed(2):r.percentage=m(T).div(u).toFixed(2),f=m(f).add(r.percentage);const h=[];for(let S=0;S<((I=c==null?void 0:c.path)==null?void 0:I.length);S++){const L=(R=c==null?void 0:c.path)==null?void 0:R[S];l.includes(L.provider)||l.push(L.provider);const B=b(L.from).full_address,O=b(L.target).full_address,U=await n(B),M=await n(O);U||e.includes(B)&&e.push(B),M||e.includes(O)&&e.push(O);const V=L.provider===E.SCALLOP||L.provider===E.FLOWX||L.provider===E.FLOWXV3;h.push({from_type:B,to_type:O,pool_address:V?"":L.id,fee_rate:L.feeRate,provider:L.provider})}r.paths=h,s.push(r)}if(e.length>0)for(const i in e)n(i);const o={router_summery:`${t.routerData.routes.length} Streams`,providers:l,routers:s};p(o);return}p(void 0)};return _.useEffect(()=>{y()},[t]),{formatSwapRouter:d}}function D(){const{getPoolAddressByCoinType:t}=C(!0);return{getSwapPoolAddress:async(d,p)=>{if(d&&p){const y=await t(d.coin_type,p.coin_type);return console.log("ðŸš€ ~ getSwapPoolAddress ~ list:",y),y}return[]}}}function z(t,n){return _.useMemo(()=>t&&n&&+t&&+n?m(n).div(t).toString():"0",[t,n])}function Q(){const{aggregatorSDK:t}=K(),{getSwapPoolAddress:n}=D(),{deepbookV3Config:d,setDeepbookV3Config:p,providers:y}=k(),A=u=>u&&u.error?u.error.code===F.InsufficientLiquidity||F.HoneyPot||F.NumberTooLarge:!1,I=async u=>{const s=y.length>0?u.filter(e=>y.includes(e)):u;if(u.includes("DEEPBOOKV3")){let e=d;const f=new Date().getTime()/1e3;if(e===null||f-((e==null?void 0:e.last_update_time)||0)>60)try{e=await t.getDeepbookV3Config(),p(e)}catch(a){console.log("ðŸš€ ~ checkProvidersKeys ~ error:",a)}if(e&&e.is_alternative_payment){const{deep_fee_vault:a}=e;if(a<H(20,6))return s.filter(o=>o!=="DEEPBOOKV3")}}return s},R=async u=>{const{fromToken:s,toToken:e,amount:f,providersKeys:a,by_amount_in:o,uuid:i}=u;try{const c={from:s.coin_type,target:e.coin_type,amount:new P(f),byAmountIn:o,depth:3,splitAlgorithm:void 0,splitFactor:void 0,splitCount:void 0,providers:a};console.log("ðŸš€ ~ file: useFindBestRouting.ts:26 ~ findBestRouters ~ routerParams:",c);const r=await t.findRouters(c);if(console.log("ðŸš€ ~ file: useFindBestRouting.ts:145 ~ findBestRouters ~ res:",r),r&&A(r))return l(!1,o,i,s,e,r);if(!r||r.routes.length===0)throw Error("not find router");return l(!1,o,i,s,e,r)}catch(c){try{console.log("ðŸš€ ~ file: useFindBestRouting.ts:105 ~ findRouters ~ error:",c);const r=await n(s,e);if(r.length===0){const S={amountIn:new P("0"),amountOut:new P("0"),byAmountIn:o,routes:[],insufficientLiquidity:!0,error:{code:F.NoRouter,msg:""}};return l(!0,o,i,s,e,S)}const T={from:s.coin_type,target:e.coin_type,amount:new P(f),byAmountIn:o,pools:r};console.log("ðŸš€ ~ file: useFindBestRouting.ts:115 ~ findRouters ~ routerParams:",T);const h=await t.swapInPools(T);return console.log("ðŸš€ ~ file: useFindBestRouting.ts:170 ~ swapInPools ~ res:",h),!h||!h.routeData?l(!0,o,i,s,e):l(!0,o,i,s,e,h.routeData)}catch(r){return console.log("ðŸš€ ~ file: useFindBestRouting.ts:120 ~ swapInPools ~  error:",r),{uuid:i,byAmountIn:o,isDegrade:!0}}}},l=(u,s,e,f,a,o)=>{var i;if(console.log("ðŸš€ ~ file: useSwap.ts:166 ~ handleRouterData ~ res:",{isDegrade:u,routerData:o}),o){const c=o.error!==void 0,r=w(o.amountIn.toString(),f.decimals).toString(),T=w(o.amountOut.toString(),a.decimals).toString();return{routerData:c?void 0:o,fromAmountUi:c?s?r:"":r,toAmountUi:c&&s?"":T,uuid:e,byAmountIn:s,isDegrade:u,errorCode:(i=o.error)==null?void 0:i.code}}else return{uuid:e,byAmountIn:s,isDegrade:u}};return{findBestRouters:R,checkProvidersKeys:I}}export{F as A,x as S,W as a,E as b,j as c,J as d,z as e,Q as u};
