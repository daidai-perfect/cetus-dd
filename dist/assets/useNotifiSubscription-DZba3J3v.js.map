<<<<<<<< HEAD:dist/assets/useNotifiSubscription-CPMb-3JU.js.map
{"version":3,"file":"useNotifiSubscription-CPMb-3JU.js","sources":["../../../cetus-design/src/hook/useNotifi/useNotifiHelper.ts","../../src/hooks/position/useCurrentPos.ts","../../src/hooks/notifi/useNotifiSubscription.ts"],"sourcesContent":["import useNotifiStore from '@cetus/stores/src/notifi'\nimport { d } from '@cetus/utils'\nimport { useGetOwnerVeNFT } from '../../../../web/src/hooks/xcetus/useXCetusHelper'\nimport { useGlobalToast } from '../../hooks'\n\nexport function useNotifiHelper() {\n  const { fetchOwnerVeNFT } = useGetOwnerVeNFT()\n  const { showCommonToast } = useGlobalToast()\n  const { notifiSources } = useNotifiStore()\n\n  // 订阅验证逻辑\n  const createNotifiSubscriptionVerify = async () => {\n    try {\n      const xCetusVenftInfo = await fetchOwnerVeNFT()\n      if (xCetusVenftInfo?.xcetus_balance) {\n        const balance = d(xCetusVenftInfo.xcetus_balance).div(Math.pow(10, 9))\n        if (balance.lessThan(1000)) {\n          showCommonToast('Price alerts are currently open to users who hold 1000+ xCETUS.', 'rejected')\n          return false\n        }\n      } else {\n        showCommonToast('Unable to fetch xCetus information.', 'rejected')\n        return false\n      }\n\n      if (notifiSources.length >= 5) {\n        showCommonToast('Price alerts can only be enabled for up to 5 positions for an account at the same time.', 'rejected')\n        return false\n      }\n\n      return true\n    } catch (error) {\n      console.error('🚀 ~ createNotifiSubscriptionVerify ~ error:', error)\n      showCommonToast('An error occurred while verifying the subscription.', 'rejected')\n      return false\n    }\n  }\n\n  // 获取指定位置的通知状态\n  const getPositionNotifiStatus = (posId: string, posIndex: string) => {\n    try {\n      const currentSource = notifiSources.find(source => {\n        const { pool_address, position_index } = JSON.parse(source.blockchainAddress)\n        return pool_address === posId && position_index === posIndex\n      })\n\n      return {\n        isSubscription: Boolean(currentSource),\n        alertID: currentSource?.alertID || ''\n      }\n    } catch (error) {\n      console.error('🚀 ~ getPositionNotifiStatus ~ error:', error)\n      return { isSubscription: false, alertID: '' }\n    }\n  }\n\n  return { createNotifiSubscriptionVerify, getPositionNotifiStatus }\n}\n","import usePositionStore from '@/store/position'\nimport usePositionDetailStore from '@/store/position/detail'\nimport { PosBaseInfo } from '@/types'\nimport useClmmSDKStore from '@cetus/stores/src/useClmmSDKStore'\nimport usePositionList from './usePositionList'\nimport useWrapPosData from './useWrapPosData'\n\nexport default function useCurrentPos() {\n  const { clmmSdk } = useClmmSDKStore()\n\n  const { posBaseList, setCurrentPosBaseInfo, setCurrentPosBaseInfoLoading } = usePositionStore()\n  const { setCurPosHistoryList, setIsPosHistoryLoading } = usePositionDetailStore()\n  const { buildPosBaseInfo } = useWrapPosData()\n  const { getPosRelatedData } = usePositionList()\n\n  const getCurrentPosBaseInfo = async (account: string, id: string, isForceRefresh: boolean = false) => {\n    setCurrentPosBaseInfoLoading(true)\n\n    const posBaseInfoFrom = posBaseList.find((item: PosBaseInfo) => item.id === id)\n    let posInfo: PosBaseInfo | null\n    if (posBaseInfoFrom && !isForceRefresh) {\n      posInfo = posBaseInfoFrom\n    } else {\n      posInfo = await getCurrentPosByPosId(account, id)\n    }\n\n    console.log('getCurrentPosBaseInfo ~ posInfo:', posBaseList, posInfo)\n\n    setCurrentPosBaseInfo(posInfo)\n\n    if (posInfo) {\n      getPosRelatedData([posInfo])\n    }\n  }\n\n  const getCurrentPosByPosId = async (account: string, id: string) => {\n    const ownerRes = await clmmSdk.fullClient.getOwnedObjectsByPage(account, {\n      options: { showType: true, showContent: true, showOwner: true },\n      filter: {\n        ObjectId: id\n      }\n    })\n\n    if (ownerRes && ownerRes.data && ownerRes.data.length > 0) {\n      const posRes = await buildPosBaseInfo(ownerRes.data[0])\n      return posRes\n    }\n    return null\n  }\n\n  const fetchPositionHistory = async (posId: string, originPosId: string) => {\n    const rpcList = ['https://mainnet.suiet.app:443', 'https://rpc-mainnet.suiscan.xyz:443']\n    for (const rpc of rpcList) {\n      try {\n        const response = await clmmSdk.Position.getPositionTransactionList({ posId, fullRpcUrl: rpc, originPosId, order: 'descending' })\n        console.log('🚀 ~ getCurrentPosHistory ~ response?.data:', response?.data, rpc)\n        if (response?.data?.length > 0) {\n          return response.data\n        }\n      } catch (error) {\n        console.error(`Error fetching data from ${rpc}:`, error)\n      }\n    }\n    return []\n  }\n\n  const getCurrentPosHistory = async (id: string, posId: string) => {\n    // posId为clmm id 也就是原始id（originPosId）\n    console.log('🚀 ~ getCurrentPosHistory ~ posId:', id, posId)\n    setIsPosHistoryLoading(true)\n\n    const clmmHistory = await fetchPositionHistory(id, posId)\n    const otherHistory = id.toLowerCase() !== posId.toLowerCase() ? await fetchPositionHistory(posId, posId) : []\n\n    console.log('🚀 ~ getCurrentPosHistory ~ clmmHistory:', clmmHistory, otherHistory, [...clmmHistory, ...otherHistory])\n    const combinedHistory = [...clmmHistory, ...otherHistory]\n    const sortedHistory = combinedHistory.sort((a: any, b: any) => b?.timestampMs - a?.timestampMs)\n\n    setCurPosHistoryList(sortedHistory)\n    setIsPosHistoryLoading(false)\n\n    console.log('🚀 ~ getCurrentPosHistory ~ result:', sortedHistory)\n  }\n  return {\n    getCurrentPosBaseInfo,\n    getCurrentPosHistory,\n    getCurrentPosByPosId\n  }\n}\n","import useNotifiAlert from '@cetus/design/src/hook/useNotifi/useNotifiAlerts'\nimport { useNotifiHelper } from '@cetus/design/src/hook/useNotifi/useNotifiHelper'\nimport { useAccountStore } from '@cetus/stores'\nimport useNotifiStore from '@cetus/stores/src/notifi'\nimport useCurrentPos from '../position/useCurrentPos'\n\ntype NotifiSubscriptionParams = {\n  subscriptionSource: string\n  position?: string\n  pool?: string\n  posIndex?: string\n  events?: any\n}\nexport default function useNotifiSubscription() {\n  const { getCurrentPosByPosId } = useCurrentPos()\n  const { currentAccount } = useAccountStore()\n  const { createNotifiAlert, getNotifiAlerts, deleteNotifiAlerts } = useNotifiAlert()\n  const { setIsChecked, setNotifiSubscriptionLoading, notifiClient } = useNotifiStore()\n  const { createNotifiSubscriptionVerify, getPositionNotifiStatus } = useNotifiHelper()\n\n  const notifiSubscription = async (notifiSubscriptionParams: NotifiSubscriptionParams) => {\n    setNotifiSubscriptionLoading(true)\n    const canSubscription = await createNotifiSubscriptionVerify()\n    if (!canSubscription) {\n      setIsChecked(false)\n      return false\n    }\n\n    const { subscriptionSource, position, posIndex, events } = notifiSubscriptionParams\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:30 ~ notifiSubscription ~ notifiSubscriptionParams:', notifiSubscriptionParams)\n    try {\n      if (subscriptionSource == 'PositionDetail') {\n        sendNotifiSubscription(String(position), String(posIndex))\n      } else {\n        const currentEvent = events.filter(event => event.type.indexOf('OpenPositionEvent') > -1)[0]\n        const stakeFarmingEvent = events.filter(event => event.type.indexOf('DepositEvent') > -1)[0]\n        const { position, pool } = currentEvent.parsedJson\n        const posId = stakeFarmingEvent ? stakeFarmingEvent.parsedJson.wrapped_position_id : currentEvent.parsedJson.position\n        const currentPosInfo = await getCurrentPosByPosId(currentAccount?.address, posId)\n        if (currentPosInfo) {\n          console.log('🚀🚀🚀 ~ file: useNotifiSubscription.ts:36 ~ notifiSubscription ~ currentPosInfo.index:', currentPosInfo.index)\n          sendNotifiSubscription(position, String(currentPosInfo.index))\n        }\n      }\n    } catch (error) {\n      setNotifiSubscriptionLoading(false)\n      console.log('🚀🚀🚀 ~ file: useNotifiSubscription.ts:45 ~ notifiSubscription ~ error:', error)\n    }\n  }\n\n  const sendNotifiSubscription = async (position: string, posIndex: string) => {\n    createNotifiAlert(position, posIndex)\n  }\n\n  const notifiUnSubscription = async (posId: string, clmmPool: string, posIndex: string) => {\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:57 ~ notifiUnSubscription ~ posId:', posId)\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:58 ~ notifiUnSubscription ~ posIndex:', posIndex)\n    const { alertID } = getPositionNotifiStatus(posId, String(posIndex))\n    if (alertID) {\n      deleteNotifiAlerts(alertID)\n    }\n  }\n\n  const getNotifiPositionTransfer = (posBaseList, notifiClient, notifiSources) => {\n    if (notifiClient && notifiClient.userState && notifiClient.userState.status == 'authenticated') {\n      console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:62 ~ getNotifiPositionTransfer ~ notifiSources:', notifiSources)\n      for (let j = 0; j < notifiSources.length; j++) {\n        const { pool_address, position_index } = JSON.parse(notifiSources[j].blockchainAddress)\n        let flag = false\n        let pos\n        for (let k = 0; k < posBaseList.length; k++) {\n          const { posId, index } = posBaseList[k]\n          if (pool_address == posId && Number(index) == Number(position_index)) {\n            flag = true\n          }\n          pos = {\n            pool_address,\n            position_index,\n            clmmPool: posBaseList[k].clmmPool\n          }\n        }\n\n        if (!flag) {\n          notifiUnSubscription(pos?.pool_address, pos?.clmmPool, pos?.position_index)\n        }\n      }\n    }\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:60 ~ getNotifiPositionTransfer ~ notifiSources:', notifiSources)\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:60 ~ getNotifiPositionTransfer ~ posBaseList:', posBaseList)\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:60 ~ getNotifiPositionTransfer ~ notifiClient:', notifiClient.us)\n  }\n\n  return { notifiSubscription, notifiUnSubscription, getNotifiPositionTransfer }\n}\n"],"names":["useNotifiHelper","fetchOwnerVeNFT","useGetOwnerVeNFT","showCommonToast","useGlobalToast","notifiSources","useNotifiStore","xCetusVenftInfo","d","error","posId","posIndex","currentSource","source","pool_address","position_index","useCurrentPos","clmmSdk","useClmmSDKStore","posBaseList","setCurrentPosBaseInfo","setCurrentPosBaseInfoLoading","usePositionStore","setCurPosHistoryList","setIsPosHistoryLoading","usePositionDetailStore","buildPosBaseInfo","useWrapPosData","getPosRelatedData","usePositionList","getCurrentPosBaseInfo","account","id","isForceRefresh","posBaseInfoFrom","item","posInfo","getCurrentPosByPosId","ownerRes","fetchPositionHistory","originPosId","rpcList","rpc","response","_a","clmmHistory","otherHistory","sortedHistory","a","b","useNotifiSubscription","currentAccount","useAccountStore","createNotifiAlert","deleteNotifiAlerts","useNotifiAlert","setIsChecked","setNotifiSubscriptionLoading","notifiClient","createNotifiSubscriptionVerify","getPositionNotifiStatus","notifiSubscription","notifiSubscriptionParams","subscriptionSource","position","events","sendNotifiSubscription","currentEvent","event","stakeFarmingEvent","pool","currentPosInfo","notifiUnSubscription","clmmPool","alertID","j","flag","pos","k","index"],"mappings":"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"}
========
{"version":3,"file":"useNotifiSubscription-DZba3J3v.js","sources":["../../../cetus-design/src/hook/useNotifi/useNotifiHelper.ts","../../src/hooks/position/useCurrentPos.ts","../../src/hooks/notifi/useNotifiSubscription.ts"],"sourcesContent":["import useNotifiStore from '@cetus/stores/src/notifi'\nimport { d } from '@cetus/utils'\nimport { useGetOwnerVeNFT } from '../../../../web/src/hooks/xcetus/useXCetusHelper'\nimport { useGlobalToast } from '../../hooks'\n\nexport function useNotifiHelper() {\n  const { fetchOwnerVeNFT } = useGetOwnerVeNFT()\n  const { showCommonToast } = useGlobalToast()\n  const { notifiSources } = useNotifiStore()\n\n  // 订阅验证逻辑\n  const createNotifiSubscriptionVerify = async () => {\n    try {\n      const xCetusVenftInfo = await fetchOwnerVeNFT()\n      if (xCetusVenftInfo?.xcetus_balance) {\n        const balance = d(xCetusVenftInfo.xcetus_balance).div(Math.pow(10, 9))\n        if (balance.lessThan(1000)) {\n          showCommonToast('Price alerts are currently open to users who hold 1000+ xCETUS.', 'rejected')\n          return false\n        }\n      } else {\n        showCommonToast('Unable to fetch xCetus information.', 'rejected')\n        return false\n      }\n\n      if (notifiSources.length >= 5) {\n        showCommonToast('Price alerts can only be enabled for up to 5 positions for an account at the same time.', 'rejected')\n        return false\n      }\n\n      return true\n    } catch (error) {\n      console.error('🚀 ~ createNotifiSubscriptionVerify ~ error:', error)\n      showCommonToast('An error occurred while verifying the subscription.', 'rejected')\n      return false\n    }\n  }\n\n  // 获取指定位置的通知状态\n  const getPositionNotifiStatus = (posId: string, posIndex: string) => {\n    try {\n      const currentSource = notifiSources.find(source => {\n        const { pool_address, position_index } = JSON.parse(source.blockchainAddress)\n        return pool_address === posId && position_index === posIndex\n      })\n\n      return {\n        isSubscription: Boolean(currentSource),\n        alertID: currentSource?.alertID || ''\n      }\n    } catch (error) {\n      console.error('🚀 ~ getPositionNotifiStatus ~ error:', error)\n      return { isSubscription: false, alertID: '' }\n    }\n  }\n\n  return { createNotifiSubscriptionVerify, getPositionNotifiStatus }\n}\n","import usePositionStore from '@/store/position'\nimport usePositionDetailStore from '@/store/position/detail'\nimport { PosBaseInfo } from '@/types'\nimport useClmmSDKStore from '@cetus/stores/src/useClmmSDKStore'\nimport usePositionList from './usePositionList'\nimport useWrapPosData from './useWrapPosData'\n\nexport default function useCurrentPos() {\n  const { clmmSdk } = useClmmSDKStore()\n\n  const { posBaseList, setCurrentPosBaseInfo, setCurrentPosBaseInfoLoading } = usePositionStore()\n  const { setCurPosHistoryList, setIsPosHistoryLoading } = usePositionDetailStore()\n  const { buildPosBaseInfo } = useWrapPosData()\n  const { getPosRelatedData } = usePositionList()\n\n  const getCurrentPosBaseInfo = async (account: string, id: string, isForceRefresh: boolean = false) => {\n    setCurrentPosBaseInfoLoading(true)\n\n    const posBaseInfoFrom = posBaseList.find((item: PosBaseInfo) => item.id === id)\n    let posInfo: PosBaseInfo | null\n    if (posBaseInfoFrom && !isForceRefresh) {\n      posInfo = posBaseInfoFrom\n    } else {\n      posInfo = await getCurrentPosByPosId(account, id)\n    }\n\n    console.log('getCurrentPosBaseInfo ~ posInfo:', posBaseList, posInfo)\n\n    setCurrentPosBaseInfo(posInfo)\n\n    if (posInfo) {\n      getPosRelatedData([posInfo])\n    }\n  }\n\n  const getCurrentPosByPosId = async (account: string, id: string) => {\n    const ownerRes = await clmmSdk.fullClient.getOwnedObjectsByPage(account, {\n      options: { showType: true, showContent: true, showOwner: true },\n      filter: {\n        ObjectId: id\n      }\n    })\n\n    if (ownerRes && ownerRes.data && ownerRes.data.length > 0) {\n      const posRes = await buildPosBaseInfo(ownerRes.data[0])\n      return posRes\n    }\n    return null\n  }\n\n  const fetchPositionHistory = async (posId: string, originPosId: string) => {\n    const rpcList = ['https://mainnet.suiet.app:443', 'https://rpc-mainnet.suiscan.xyz:443']\n    for (const rpc of rpcList) {\n      try {\n        const response = await clmmSdk.Position.getPositionTransactionList({ posId, fullRpcUrl: rpc, originPosId, order: 'descending' })\n        console.log('🚀 ~ getCurrentPosHistory ~ response?.data:', response?.data, rpc)\n        if (response?.data?.length > 0) {\n          return response.data\n        }\n      } catch (error) {\n        console.error(`Error fetching data from ${rpc}:`, error)\n      }\n    }\n    return []\n  }\n\n  const getCurrentPosHistory = async (id: string, posId: string) => {\n    // posId为clmm id 也就是原始id（originPosId）\n    console.log('🚀 ~ getCurrentPosHistory ~ posId:', id, posId)\n    setIsPosHistoryLoading(true)\n\n    const clmmHistory = await fetchPositionHistory(id, posId)\n    const otherHistory = id.toLowerCase() !== posId.toLowerCase() ? await fetchPositionHistory(posId, posId) : []\n\n    console.log('🚀 ~ getCurrentPosHistory ~ clmmHistory:', clmmHistory, otherHistory, [...clmmHistory, ...otherHistory])\n    const combinedHistory = [...clmmHistory, ...otherHistory]\n    const sortedHistory = combinedHistory.sort((a: any, b: any) => b?.timestampMs - a?.timestampMs)\n\n    setCurPosHistoryList(sortedHistory)\n    setIsPosHistoryLoading(false)\n\n    console.log('🚀 ~ getCurrentPosHistory ~ result:', sortedHistory)\n  }\n  return {\n    getCurrentPosBaseInfo,\n    getCurrentPosHistory,\n    getCurrentPosByPosId\n  }\n}\n","import useNotifiAlert from '@cetus/design/src/hook/useNotifi/useNotifiAlerts'\nimport { useNotifiHelper } from '@cetus/design/src/hook/useNotifi/useNotifiHelper'\nimport { useAccountStore } from '@cetus/stores'\nimport useNotifiStore from '@cetus/stores/src/notifi'\nimport useCurrentPos from '../position/useCurrentPos'\n\ntype NotifiSubscriptionParams = {\n  subscriptionSource: string\n  position?: string\n  pool?: string\n  posIndex?: string\n  events?: any\n}\nexport default function useNotifiSubscription() {\n  const { getCurrentPosByPosId } = useCurrentPos()\n  const { currentAccount } = useAccountStore()\n  const { createNotifiAlert, getNotifiAlerts, deleteNotifiAlerts } = useNotifiAlert()\n  const { setIsChecked, setNotifiSubscriptionLoading, notifiClient } = useNotifiStore()\n  const { createNotifiSubscriptionVerify, getPositionNotifiStatus } = useNotifiHelper()\n\n  const notifiSubscription = async (notifiSubscriptionParams: NotifiSubscriptionParams) => {\n    setNotifiSubscriptionLoading(true)\n    const canSubscription = await createNotifiSubscriptionVerify()\n    if (!canSubscription) {\n      setIsChecked(false)\n      return false\n    }\n\n    const { subscriptionSource, position, posIndex, events } = notifiSubscriptionParams\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:30 ~ notifiSubscription ~ notifiSubscriptionParams:', notifiSubscriptionParams)\n    try {\n      if (subscriptionSource == 'PositionDetail') {\n        sendNotifiSubscription(String(position), String(posIndex))\n      } else {\n        const currentEvent = events.filter(event => event.type.indexOf('OpenPositionEvent') > -1)[0]\n        const stakeFarmingEvent = events.filter(event => event.type.indexOf('DepositEvent') > -1)[0]\n        const { position, pool } = currentEvent.parsedJson\n        const posId = stakeFarmingEvent ? stakeFarmingEvent.parsedJson.wrapped_position_id : currentEvent.parsedJson.position\n        const currentPosInfo = await getCurrentPosByPosId(currentAccount?.address, posId)\n        if (currentPosInfo) {\n          console.log('🚀🚀🚀 ~ file: useNotifiSubscription.ts:36 ~ notifiSubscription ~ currentPosInfo.index:', currentPosInfo.index)\n          sendNotifiSubscription(position, String(currentPosInfo.index))\n        }\n      }\n    } catch (error) {\n      setNotifiSubscriptionLoading(false)\n      console.log('🚀🚀🚀 ~ file: useNotifiSubscription.ts:45 ~ notifiSubscription ~ error:', error)\n    }\n  }\n\n  const sendNotifiSubscription = async (position: string, posIndex: string) => {\n    createNotifiAlert(position, posIndex)\n  }\n\n  const notifiUnSubscription = async (posId: string, clmmPool: string, posIndex: string) => {\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:57 ~ notifiUnSubscription ~ posId:', posId)\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:58 ~ notifiUnSubscription ~ posIndex:', posIndex)\n    const { alertID } = getPositionNotifiStatus(posId, String(posIndex))\n    if (alertID) {\n      deleteNotifiAlerts(alertID)\n    }\n  }\n\n  const getNotifiPositionTransfer = (posBaseList, notifiClient, notifiSources) => {\n    if (notifiClient && notifiClient.userState && notifiClient.userState.status == 'authenticated') {\n      console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:62 ~ getNotifiPositionTransfer ~ notifiSources:', notifiSources)\n      for (let j = 0; j < notifiSources.length; j++) {\n        const { pool_address, position_index } = JSON.parse(notifiSources[j].blockchainAddress)\n        let flag = false\n        let pos\n        for (let k = 0; k < posBaseList.length; k++) {\n          const { posId, index } = posBaseList[k]\n          if (pool_address == posId && Number(index) == Number(position_index)) {\n            flag = true\n          }\n          pos = {\n            pool_address,\n            position_index,\n            clmmPool: posBaseList[k].clmmPool\n          }\n        }\n\n        if (!flag) {\n          notifiUnSubscription(pos?.pool_address, pos?.clmmPool, pos?.position_index)\n        }\n      }\n    }\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:60 ~ getNotifiPositionTransfer ~ notifiSources:', notifiSources)\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:60 ~ getNotifiPositionTransfer ~ posBaseList:', posBaseList)\n    console.log('🚀🚀🚀 ~ useNotifiSubscription.ts:60 ~ getNotifiPositionTransfer ~ notifiClient:', notifiClient.us)\n  }\n\n  return { notifiSubscription, notifiUnSubscription, getNotifiPositionTransfer }\n}\n"],"names":["useNotifiHelper","fetchOwnerVeNFT","useGetOwnerVeNFT","showCommonToast","useGlobalToast","notifiSources","useNotifiStore","xCetusVenftInfo","d","error","posId","posIndex","currentSource","source","pool_address","position_index","useCurrentPos","clmmSdk","useClmmSDKStore","posBaseList","setCurrentPosBaseInfo","setCurrentPosBaseInfoLoading","usePositionStore","setCurPosHistoryList","setIsPosHistoryLoading","usePositionDetailStore","buildPosBaseInfo","useWrapPosData","getPosRelatedData","usePositionList","getCurrentPosBaseInfo","account","id","isForceRefresh","posBaseInfoFrom","item","posInfo","getCurrentPosByPosId","ownerRes","fetchPositionHistory","originPosId","rpcList","rpc","response","_a","clmmHistory","otherHistory","sortedHistory","a","b","useNotifiSubscription","currentAccount","useAccountStore","createNotifiAlert","deleteNotifiAlerts","useNotifiAlert","setIsChecked","setNotifiSubscriptionLoading","notifiClient","createNotifiSubscriptionVerify","getPositionNotifiStatus","notifiSubscription","notifiSubscriptionParams","subscriptionSource","position","events","sendNotifiSubscription","currentEvent","event","stakeFarmingEvent","pool","currentPosInfo","notifiUnSubscription","clmmPool","alertID","j","flag","pos","k","index"],"mappings":"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"}
>>>>>>>> 48e3e63a7d52715810f0754e6a7d258ba01f9a12:dist/assets/useNotifiSubscription-DZba3J3v.js.map
