import{u as $t}from"./global-slHCIAkx.js";import{c as Rt}from"./usePositionList-CbzmdxM_.js";import{a as Et,u as Ot}from"./useCurrentPos-DIoMsKOq.js";import{M as K}from"./msafe-oYBkW7LJ.js";import{u as Nt}from"./useAccountBalance-D0aHs2Xi.js";import{aI as Gt,R as Ut,a5 as Vt,r as b,a8 as Kt,aP as jt,a1 as Wt,d as q,as as dt,bg as Q,bh as Xt,X as F,aR as zt,a7 as Ht,aS as ct}from"./index-DxlrRVJO.js";import{u as rt}from"./useTokenBalance-DlbLPUOA.js";import{u as Jt}from"./useTransaction-Dgi2y8iu.js";import{u as Qt}from"./useInsufficientBalanceToast-DXl5tGxh.js";import{v as lt}from"./index--aPuE2x1.js";function ce(){const{clmmSdk:mt}=Gt(),{peripherySdk:Y}=Ut(),{currentPosBaseInfo:t,posPoolsOriginalData:Yt,posPoolsRelatedData:Zt,posRewardsData:ut}=Rt(),Z=ut[t==null?void 0:t.posId],{getTokenAmountValue:P}=Vt(),{getCurrentPosBaseInfo:pt}=Et(),{currentPoolSqrtPrice:B,tokenAmountA:g,tokenAmountB:T,isFixedDisplayTokenA:C,setIsFixedDisplayTokenA:At,setTokenAmountA:R,setTokenAmountB:E,curPosContractPoolInfo:c,currentPosDetailTab:gt,isPosDetailRefresh:I}=Ot(),[Tt,j]=b.useState(!1),[kt,xt]=b.useState(""),[St,bt]=b.useState(""),s=t==null?void 0:t.displayTokenA,n=t==null?void 0:t.displayTokenB,{slippage:O,mevProtect:yt,maxCapForGas:wt,transactionMode:_t,customGasPrice:ft}=$t(),{balanceInfo:v}=rt(s),{balanceInfo:$}=rt(n),Mt=P(s==null?void 0:s.coin_type,g),Dt=P(n==null?void 0:n.coin_type,T),[W,X]=b.useState(""),tt=b.useRef("");b.useEffect(()=>{console.log("ðŸš€ ~ usePosAdd ~ uuid:",W),tt.current=W},[W]);const N=()=>{R(""),E(""),j(!1),X("")},G=b.useMemo(()=>{if(console.log("ðŸš€ ~ showTokenALock ~ curPosContractPoolInfo:",t,c),t&&c){const{lowerTick:e,upperTick:o}=t,i=c==null?void 0:c.current_tick_index;if(i!==void 0&&e!==void 0&&o!==void 0)return i>=e&&i<o?!1:i>=o?!0:!(i<e)}return!1},[c==null?void 0:c.current_tick_index,t]),U=b.useMemo(()=>{if(t&&c){const{lowerTick:e,upperTick:o}=t,i=c==null?void 0:c.current_tick_index;if(i!==void 0&&e!==void 0&&o!==void 0)return i>=e&&i<o||i>=o?!1:(i<e,!0)}return!1},[c==null?void 0:c.current_tick_index,t]),L=t!=null&&t.isReverse?U:G,h=t!=null&&t.isReverse?G:U,et=e=>{console.log("ðŸš€ ~ usePosAdd ~ params:",e);const{amount:o,tokenA:i,tokenB:S,isTokenA:u,lowerTick:p,upperTick:k,curSqrtPrice:x,isReverse:l,roundUp:y}=e,w=new Q(o);console.log("ðŸš€ ~ usePosAdd ~ coinAmount:",O,x,w.toString());const{coinAmountA:a,coinAmountB:d,tokenMaxA:_,tokenMaxB:f,liquidityAmount:A}=Xt.estLiquidityAndcoinAmountFromOneAmounts(p,k,w,u,y,q(O).toNumber(),new Q(x));console.log("ðŸš€ ~ usePosAdd ~ coinAmountA:",a.toString()),console.log("ðŸš€ ~ usePosAdd ~ coinAmountB:",d.toString());const r=i.decimals,m=S.decimals;return{coinAmountAOrigin:a.toString(),coinAmountBOrigin:d.toString(),displayCoinAmountA:l?F(d.toString(),m):F(a.toString(),r),displayCoinAmountB:l?F(a.toString(),r):F(d.toString(),m),coinAmountA:F(a.toString(),r),coinAmountB:F(d.toString(),m),tokenMaxA:_.toString(),tokenMaxB:f.toString(),liquidityAmount:A.toString()}},ot=Kt((e,o,i)=>{var A,r;const S=o?(A=t==null?void 0:t.displayTokenA)==null?void 0:A.decimals:(r=t==null?void 0:t.displayTokenB)==null?void 0:r.decimals,u=jt(e,S),p=t==null?void 0:t.tokenA,k=t==null?void 0:t.tokenB,x=t==null?void 0:t.lowerTick,l=t==null?void 0:t.upperTick,y=t==null?void 0:t.isReverse,w={amount:u,tokenA:p,tokenB:k,isTokenA:y?!o:o,lowerTick:x,upperTick:l,curSqrtPrice:B,isReverse:y,roundUp:!0};console.log("ðŸš€ ~ debouncedPreAdd ~ params:",w);const{displayCoinAmountA:a,displayCoinAmountB:d,tokenMaxA:_,tokenMaxB:f}=et(w);tt.current===i?(xt(_),bt(f),o?E(d||""):R(a||"")):N(),j(!1)},500),V=()=>{if((g||T)&&zt(t)){console.log("ðŸš€ ~ reCalculateResult ~ currentPosBaseInfo:",t);const e=C?g:T;if(+e){const o=lt();X(o),ot(e,C,o)}}};b.useEffect(()=>{gt=="increase"&&I&&V()},[I]);const qt=(e,o)=>{if(console.log("ðŸš€ ~ handleAmountChange ~ amount:",!e,+e,e),!e){N();return}if(At(o),o?R(e):E(e),+e){j(!0);const i=lt();X(i),console.log("ðŸš€ ~ handleAmountChange ~ params:",e),ot(e,o,i)}else o?E(""):R("")},it=async e=>{const{poolAddress:o,coinTypeA:i,coinTypeB:S,fixAmountA:u,amountA:p,amountB:k,lowerTick:x,upperTick:l,currentSqrtPrice:y,posType:w,rewarderCoinTypes:a,posIndex:d,posId:_,farmsPoolId:f}=e,A={coinTypeA:i,coinTypeB:S,amount_a:p,amount_b:k,pool_id:o,fix_amount_a:u,slippage:q(O).toNumber(),is_open:!d,tick_lower:x,tick_upper:l,collect_fee:!!d,rewarder_coin_types:a,pos_id:_||""},r={slippage:q(O).toNumber(),curSqrtPrice:new Q(y)},m=await mt.Position.createAddLiquidityFixTokenPayload(A,r),D={action:d?K.IncreaseLiquidity:K.OpenAndAddLiquidity,txbParams:{parameter:A,gasEstimateArg:r}};return console.log("ðŸš€ ~ getClmmCreateAddData ~ msafeParams:",D,m),{tx:m,msafeParams:D}},st=async e=>{const{poolAddress:o,coinTypeA:i,coinTypeB:S,fixAmountA:u,amountA:p,amountB:k,lowerTick:x,upperTick:l,currentSqrtPrice:y,posType:w,rewarderCoinTypes:a,posIndex:d,posId:_,farmsPoolId:f}=e;let A,r;if(_){const m={pool_id:f||"",coinTypeA:i,coinTypeB:S,position_nft_id:_,clmm_pool_id:o,amount_a:p,amount_b:k,collect_fee:!0,collect_rewarder:!1,fix_amount_a:u,clmm_rewarder_types:a};A=await Y.Farms.addLiquidityFixCoinPayload(m),r={action:K.FarmingIncreaseLiquidity,txbParams:m}}else{const m={pool_id:f||"",coinTypeA:i,coinTypeB:S,clmm_pool_id:o,amount_a:p,amount_b:k,fix_amount_a:u,tick_lower:x,tick_upper:l};A=await Y.Farms.openPositionAddLiquidityStakePaylod(m),r={action:K.FarmingOpenAndAddLiquidity,txbParams:m}}return console.log("ðŸš€ ~ getFarmsCreateAddData ~ msafeParams:",r,A),{tx:A,msafeParams:r}},nt=e=>{const{posType:o}=e;return o==="clmm"?it(e):st(e)},{currentAccount:M}=Wt(),Ct=b.useMemo(()=>{const e={text:"Add More Liquidity",disabled:!1};return M!=null&&M.address?!+g&&!+T?(e.text="Enter an amount",e.disabled=!0,e):!L&&g&&q(g).gt((v==null?void 0:v.balanceFormat)||0)?(e.disabled=!0,e.text=`Insufficient ${dt(s==null?void 0:s.symbol,10)} Balance`,e):!h&&T&&q(T).gt(($==null?void 0:$.balanceFormat)||0)?(e.disabled=!0,e.text=`Insufficient ${dt(n==null?void 0:n.symbol,10)} Balance`,e):((!G&&!U&&(!+g||!+T)||(t==null?void 0:t.posType)=="burn")&&(e.disabled=!0),e):(e.text="Connect Wallet",e.disabled=!1,e)},[g,T,v,$,M==null?void 0:M.address]),{signAndExecuteTransaction:Lt}=Jt(),[ht,z]=b.useState(!1),{fetchAccountBalance:Ft}=Nt(),{showInsufficientBalanceToast:vt}=Qt();return{reCalculateResult:V,preAddLoading:Tt,preAdd:et,getAddTsPayload:nt,displayTokenA:s,displayTokenB:n,tokenABalanceInfo:v,tokenBBalanceInfo:$,tokenAmountValueA:Mt,tokenAmountValueB:Dt,handleAmountChange:qt,resetInputAmount:N,btnStatusText:Ct,toAdd:async()=>{var w;z(!0);const e=C?g:T,o=C?s.decimals:n.decimals,i=q(e).mul(Ht.pow(10,o)).toString(),S=t!=null&&t.isReverse?!C:C;let u,p;const k=t==null?void 0:t.lowerTick,x=t==null?void 0:t.upperTick,l=c==null?void 0:c.current_tick_index;l!==void 0&&k&&x&&(l>=k&&l<=x?(u=S?i:kt,p=S?St:i):l>x?(u=0,p=i):l<k&&(u=i,p=0)),console.log("ðŸš€ ~ toAdd ~ lowerTick:",k,x,l),console.log("ðŸš€ ~ toAdd ~ amount_a:",t,u,p);const y=(w=Z||[])==null?void 0:w.reduce((a,d)=>(q(d==null?void 0:d.amount_owed).gt(0)&&a.push(d.coin_address),a),[]);console.log("ðŸš€ ~ toAdd ~ rewarderCoinTypes:",Z,y);try{const a={poolAddress:t==null?void 0:t.clmmPool,coinTypeA:t==null?void 0:t.coinTypeA,coinTypeB:t==null?void 0:t.coinTypeB,amountA:u,amountB:p,fixAmountA:S,lowerTick:t==null?void 0:t.lowerTick,upperTick:t==null?void 0:t.upperTick,currentSqrtPrice:B,posType:t==null?void 0:t.posType,rewarderCoinTypes:y,posIndex:t==null?void 0:t.index,posId:(t==null?void 0:t.posType)=="farms"?t==null?void 0:t.id:t==null?void 0:t.posId};(t==null?void 0:t.posType)=="farms"&&(a.farmsPoolId=t==null?void 0:t.farmsPool),console.log("ðŸš€ ~ toAdd ~ params:",a);const{tx:d,msafeParams:_}=await nt(a),f=await Lt(d,{getShowInfo:(A,r)=>{const m=!L&&!h?`Add ${g} ${s==null?void 0:s.symbol} and ${T} ${n==null?void 0:n.symbol}`:L?h?"Add Liquidity":`Add ${T} ${n==null?void 0:n.symbol}`:`Add ${g} ${s==null?void 0:s.symbol}`,D={modalDescriptionText:m,toastTitleText:m};if(A==="success"){let H=g,J=T;r&&(H=ct(r,s)||g,J=ct(r,n)||T);const at=!L&&!h?`Add ${H} ${s==null?void 0:s.symbol} and ${J} ${n==null?void 0:n.symbol}`:L?h?"Add Liquidity":`Add ${J} ${n==null?void 0:n.symbol}`:`Add ${H} ${s==null?void 0:s.symbol}`;D.toastDescriptionContent=at,D.modalDescriptionText=at,D.toastTitleText="Supplied Successful"}return D}},{useMev:yt,useFastMode:_t==="Fast Mode",maxCapForGas:wt,customGasPrice:ft,msafeParams:_});console.log("ðŸš€ ~ toClaim ~ res:",f),f?(Ft(),N(),pt(M==null?void 0:M.address,t==null?void 0:t.id,!0)):V(),z(!1)}catch(a){console.log("ðŸš€ ~ toClaim ~ error:",a),V(),vt(String(a)),z(!1)}},isAddLoading:ht,showTokenALock:G,showTokenBLock:U,showDisplayTokenALock:L,showDisplayTokenBLock:h,getClmmCreateAddData:it,getFarmsCreateAddData:st}}export{ce as u};
