import{u as ht}from"./global-iZ7St_zm.js";import{c as Ct}from"./usePositionList-CyCzZNts.js";import{a as Et,u as Ot}from"./useCurrentPos-CwMCqO3d.js";import{M as V}from"./msafe-oYBkW7LJ.js";import{u as Nt}from"./useAccountBalance-D-weOZgA.js";import{aH as Gt,R as Ut,a4 as Vt,r as S,a7 as Ht,a1 as Kt,d as D,as as at,bh as J,bi as jt,X as $,aP as Wt,aR as Xt,a6 as zt,aS as ct}from"./index-D49RffYW.js";import{u as dt}from"./useTokenBalance-Cc02jFZo.js";import{u as Jt}from"./useTransaction-i5gFyneH.js";import{u as Qt}from"./useInsufficientBalanceToast-oZJ3kO4O.js";import{v as rt}from"./index-BzKWeyUu.js";function re(){const{clmmSdk:mt}=Gt(),{peripherySdk:Q}=Ut(),{currentPosBaseInfo:t,posPoolsOriginalData:Yt,posPoolsRelatedData:Zt,posRewardsData:ut}=Ct(),lt=ut[t==null?void 0:t.posId],{getTokenAmountValue:Y}=Vt(),{getCurrentPosBaseInfo:pt,getCurrentPosHistory:Bt}=Et(),{currentPoolSqrtPrice:Z,tokenAmountA:l,tokenAmountB:p,isFixedDisplayTokenA:q,setIsFixedDisplayTokenA:At,setTokenAmountA:C,setTokenAmountB:E,curPosContractPoolInfo:d,currentPosDetailTab:Tt,isPosDetailRefresh:B}=Ot(),[kt,H]=S.useState(!1),[xt,bt]=S.useState(""),[yt,St]=S.useState(""),s=t==null?void 0:t.displayTokenA,n=t==null?void 0:t.displayTokenB,{slippage:K,mevProtect:gt,maxCapForGas:_t,transactionMode:wt,customGasPrice:ft}=ht(),{balanceInfo:R}=dt(s),{balanceInfo:h}=dt(n),Mt=Y(s==null?void 0:s.coin_type,l),Dt=Y(n==null?void 0:n.coin_type,p),[P,j]=S.useState(""),I=S.useRef("");S.useEffect(()=>{I.current=P},[P]);const O=()=>{C(""),E(""),H(!1),j("")},N=S.useMemo(()=>{if(t&&d){const{lowerTick:e,upperTick:i}=t,o=d==null?void 0:d.current_tick_index;if(o!==void 0&&e!==void 0&&i!==void 0)return o>=e&&o<i?!1:o>=i?!0:!(o<e)}return!1},[d==null?void 0:d.current_tick_index,t]),G=S.useMemo(()=>{if(t&&d){const{lowerTick:e,upperTick:i}=t,o=d==null?void 0:d.current_tick_index;if(o!==void 0&&e!==void 0&&i!==void 0)return o>=e&&o<i||o>=i?!1:(o<e,!0)}return!1},[d==null?void 0:d.current_tick_index,t]),L=t!=null&&t.isReverse?G:N,v=t!=null&&t.isReverse?N:G,tt=e=>{const{amount:i,tokenA:o,tokenB:x,isTokenA:A,lowerTick:T,upperTick:b,curSqrtPrice:y,isReverse:m,roundUp:w}=e,f=new J(i),{coinAmountA:a,coinAmountB:c,tokenMaxA:g,tokenMaxB:M,liquidityAmount:k}=jt.estLiquidityAndcoinAmountFromOneAmounts(T,b,f,A,w,D(K).toNumber(),new J(y)),r=o.decimals,u=x.decimals;return{coinAmountAOrigin:a.toString(),coinAmountBOrigin:c.toString(),displayCoinAmountA:m?$(c.toString(),u):$(a.toString(),r),displayCoinAmountB:m?$(a.toString(),r):$(c.toString(),u),coinAmountA:$(a.toString(),r),coinAmountB:$(c.toString(),u),tokenMaxA:g.toString(),tokenMaxB:M.toString(),liquidityAmount:k.toString()}},et=Ht((e,i,o)=>{var k,r;const x=i?(k=t==null?void 0:t.displayTokenA)==null?void 0:k.decimals:(r=t==null?void 0:t.displayTokenB)==null?void 0:r.decimals,A=Wt(e,x),T=t==null?void 0:t.tokenA,b=t==null?void 0:t.tokenB,y=t==null?void 0:t.lowerTick,m=t==null?void 0:t.upperTick,w=t==null?void 0:t.isReverse,f={amount:A,tokenA:T,tokenB:b,isTokenA:w?!i:i,lowerTick:y,upperTick:m,curSqrtPrice:Z,isReverse:w,roundUp:!0},{displayCoinAmountA:a,displayCoinAmountB:c,tokenMaxA:g,tokenMaxB:M}=tt(f);I.current===o?(bt(g),St(M),i?E(c||""):C(a||"")):O(),H(!1)},500),U=()=>{if((l||p)&&Xt(t)){const e=q?l:p;if(+e){const i=rt();j(i),et(e,q,i)}}};S.useEffect(()=>{Tt=="increase"&&B&&U()},[B]);const qt=(e,i)=>{if(!e){O();return}if(At(i),i?C(e):E(e),+e){H(!0);const o=rt();j(o),et(e,i,o)}else i?E(""):C("")},it=async e=>{const{poolAddress:i,coinTypeA:o,coinTypeB:x,fixAmountA:A,amountA:T,amountB:b,lowerTick:y,upperTick:m,currentSqrtPrice:w,posType:f,rewarderCoinTypes:a,posIndex:c,posId:g,farmsPoolId:M}=e,k={coinTypeA:o,coinTypeB:x,amount_a:T,amount_b:b,pool_id:i,fix_amount_a:A,slippage:D(K).toNumber(),is_open:!c,tick_lower:y,tick_upper:m,collect_fee:!!c,rewarder_coin_types:a,pos_id:g||""},r={slippage:D(K).toNumber(),curSqrtPrice:new J(w)},u=await mt.Position.createAddLiquidityFixTokenPayload(k,r),F={action:c?V.IncreaseLiquidity:V.OpenAndAddLiquidity,txbParams:{parameter:k,gasEstimateArg:r}};return{tx:u,msafeParams:F}},ot=async e=>{const{poolAddress:i,coinTypeA:o,coinTypeB:x,fixAmountA:A,amountA:T,amountB:b,lowerTick:y,upperTick:m,currentSqrtPrice:w,posType:f,rewarderCoinTypes:a,posIndex:c,posId:g,farmsPoolId:M}=e;let k,r;if(g){const u={pool_id:M||"",coinTypeA:o,coinTypeB:x,position_nft_id:g,clmm_pool_id:i,amount_a:T,amount_b:b,collect_fee:!0,collect_rewarder:!1,fix_amount_a:A,clmm_rewarder_types:a};k=await Q.Farms.addLiquidityFixCoinPayload(u),r={action:V.FarmingIncreaseLiquidity,txbParams:u}}else{const u={pool_id:M||"",coinTypeA:o,coinTypeB:x,clmm_pool_id:i,amount_a:T,amount_b:b,fix_amount_a:A,tick_lower:y,tick_upper:m};k=await Q.Farms.openPositionAddLiquidityStakePaylod(u),r={action:V.FarmingOpenAndAddLiquidity,txbParams:u}}return{tx:k,msafeParams:r}},st=e=>{const{posType:i}=e;return i==="clmm"?it(e):ot(e)},{currentAccount:_}=Kt(),Lt=S.useMemo(()=>{const e={text:"Add More Liquidity",disabled:!1};return _!=null&&_.address?!+l&&!+p?(e.text="Enter an amount",e.disabled=!0,e):!L&&l&&D(l).gt((R==null?void 0:R.balanceFormat)||0)?(e.disabled=!0,e.text=`Insufficient ${at(s==null?void 0:s.symbol,10)} Balance`,e):!v&&p&&D(p).gt((h==null?void 0:h.balanceFormat)||0)?(e.disabled=!0,e.text=`Insufficient ${at(n==null?void 0:n.symbol,10)} Balance`,e):((!N&&!G&&(!+l||!+p)||(t==null?void 0:t.posType)=="burn")&&(e.disabled=!0),e):(e.text="Connect Wallet",e.disabled=!1,e)},[l,p,R,h,_==null?void 0:_.address]),{signAndExecuteTransaction:vt}=Jt(),[Ft,W]=S.useState(!1),{fetchAccountBalance:$t}=Nt(),{showInsufficientBalanceToast:Rt}=Qt();return{reCalculateResult:U,preAddLoading:kt,preAdd:tt,getAddTsPayload:st,displayTokenA:s,displayTokenB:n,tokenABalanceInfo:R,tokenBBalanceInfo:h,tokenAmountValueA:Mt,tokenAmountValueB:Dt,handleAmountChange:qt,resetInputAmount:O,btnStatusText:Lt,toAdd:async()=>{var f;W(!0);const e=q?l:p,i=q?s.decimals:n.decimals,o=D(e).mul(zt.pow(10,i)).toString(),x=t!=null&&t.isReverse?!q:q;let A,T;const b=t==null?void 0:t.lowerTick,y=t==null?void 0:t.upperTick,m=d==null?void 0:d.current_tick_index;m!==void 0&&b&&y&&(m>=b&&m<=y?(A=x?o:xt,T=x?yt:o):m>y?(A=0,T=o):m<b&&(A=o,T=0));const w=(f=lt||[])==null?void 0:f.reduce((a,c)=>(D(c==null?void 0:c.amount_owed).gt(0)&&a.push(c.coin_address),a),[]);try{const a={poolAddress:t==null?void 0:t.clmmPool,coinTypeA:t==null?void 0:t.coinTypeA,coinTypeB:t==null?void 0:t.coinTypeB,amountA:A,amountB:T,fixAmountA:x,lowerTick:t==null?void 0:t.lowerTick,upperTick:t==null?void 0:t.upperTick,currentSqrtPrice:Z,posType:t==null?void 0:t.posType,rewarderCoinTypes:w,posIndex:t==null?void 0:t.index,posId:(t==null?void 0:t.posType)=="farms"?t==null?void 0:t.id:t==null?void 0:t.posId};(t==null?void 0:t.posType)=="farms"&&(a.farmsPoolId=t==null?void 0:t.farmsPool);const{tx:c,msafeParams:g}=await st(a);await vt(c,{getShowInfo:(k,r)=>{const u=!L&&!v?`Add ${l} ${s==null?void 0:s.symbol} and ${p} ${n==null?void 0:n.symbol}`:L?v?"Add Liquidity":`Add ${p} ${n==null?void 0:n.symbol}`:`Add ${l} ${s==null?void 0:s.symbol}`,F={modalDescriptionText:u,toastTitleText:u};if(k==="success"){let X=l,z=p;r&&(X=ct(r,s)||l,z=ct(r,n)||p);const nt=!L&&!v?`Add ${X} ${s==null?void 0:s.symbol} and ${z} ${n==null?void 0:n.symbol}`:L?v?"Add Liquidity":`Add ${z} ${n==null?void 0:n.symbol}`:`Add ${X} ${s==null?void 0:s.symbol}`;F.toastDescriptionContent=nt,F.modalDescriptionText=nt,F.toastTitleText="Supplied Successful"}return F}},{useMev:gt,useFastMode:wt==="Fast Mode",maxCapForGas:_t,customGasPrice:ft,msafeParams:g})?($t(),O(),pt(_==null?void 0:_.address,t==null?void 0:t.id,!0)):U(),W(!1)}catch(a){U(),Rt(String(a)),W(!1)}},isAddLoading:Ft,showTokenALock:N,showTokenBLock:G,showDisplayTokenALock:L,showDisplayTokenBLock:v,getClmmCreateAddData:it,getFarmsCreateAddData:ot}}export{re as u};
