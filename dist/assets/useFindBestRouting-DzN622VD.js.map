{"version":3,"file":"useFindBestRouting-DzN622VD.js","sources":["../../src/hooks/swap/useFindBestRouting.ts"],"sourcesContent":["import { AggregatorServerErrorCode, SwapRouterData } from '@/types/swap'\nimport useClmmSDKStore from '@cetus/stores/src/useClmmSDKStore'\nimport useWebConfigStore from '@cetus/stores/src/useWebConfigStore'\nimport { Token } from '@cetus/types'\nimport { fromDecimalsAmountFix } from '@cetus/utils'\nimport { FindRouterParams, RouterData, SwapInPoolsParams } from '@cetusprotocol/aggregator-sdk'\nimport { toDecimalsAmount } from '@cetusprotocol/common-sdk'\nimport BN from 'bn.js'\nimport { useGetSwapPoolAddressList } from './useSwapHelper'\n\nexport function useFindBestRouting() {\n  const { aggregatorSDK } = useClmmSDKStore()\n  const { getSwapPoolAddress } = useGetSwapPoolAddressList()\n  const { deepbookV3Config, setDeepbookV3Config, providers } = useWebConfigStore()\n  /**\n   * 是否禁用降级\n   * @param res\n   * @returns\n   */\n  const isDisableDegrade = (res: RouterData | null) => {\n    if (res && res.error) {\n      const code = res.error.code\n      return (\n        code === AggregatorServerErrorCode.InsufficientLiquidity || AggregatorServerErrorCode.HoneyPot || AggregatorServerErrorCode.NumberTooLarge\n      )\n    }\n\n    return false\n  }\n\n  const checkProvidersKeys = async (providersKeys: string[]) => {\n    const tempProvidersKeys = providers.length > 0 ? providersKeys.filter(item => providers.includes(item)) : providersKeys\n    if (providersKeys.includes('DEEPBOOKV3')) {\n      let config = deepbookV3Config as any\n      const nowTime = new Date().getTime() / 1000\n      if (config === null || nowTime - (config?.last_update_time || 0) > 60) {\n        try {\n          config = await aggregatorSDK.getDeepbookV3Config()\n\n          setDeepbookV3Config(config)\n        } catch (error) {\n          console.log('🚀 ~ checkProvidersKeys ~ error:', error)\n        }\n      }\n      if (config && config.is_alternative_payment) {\n        const { deep_fee_vault } = config\n        if (deep_fee_vault < toDecimalsAmount(20, 6)) {\n          return tempProvidersKeys.filter(item => item !== 'DEEPBOOKV3')\n        }\n      }\n    }\n\n    return tempProvidersKeys\n  }\n\n  /**\n   * 预计算\n   */\n  const findBestRouters = async (options: {\n    fromToken: Token\n    toToken: Token\n    amount: string\n    providersKeys: string[]\n    by_amount_in: boolean\n    uuid: string\n  }): Promise<SwapRouterData> => {\n    const { fromToken, toToken, amount, providersKeys, by_amount_in, uuid } = options\n\n    try {\n      const routerParams: FindRouterParams = {\n        from: fromToken.coin_type,\n        target: toToken.coin_type,\n        amount: new BN(amount),\n        byAmountIn: by_amount_in,\n        depth: 3,\n        splitAlgorithm: undefined,\n        splitFactor: undefined,\n        splitCount: undefined,\n        providers: providersKeys\n      }\n\n      console.log('🚀 ~ file: useFindBestRouting.ts:26 ~ findBestRouters ~ routerParams:', routerParams)\n\n      const res = await aggregatorSDK.findRouters(routerParams)\n      console.log('🚀 ~ file: useFindBestRouting.ts:145 ~ findBestRouters ~ res:', res)\n\n      if (res && isDisableDegrade(res)) {\n        // 流动性不足\n        return handleRouterData(false, by_amount_in, uuid, fromToken, toToken, res)\n      } else {\n        if (!res || res.routes.length === 0) {\n          throw Error('not find router')\n        }\n        return handleRouterData(false, by_amount_in, uuid, fromToken, toToken, res)\n      }\n    } catch (error) {\n      //走降级\n      try {\n        console.log('🚀 ~ file: useFindBestRouting.ts:105 ~ findRouters ~ error:', error)\n\n        const pools = await getSwapPoolAddress(fromToken, toToken)\n        if (pools.length === 0) {\n          const dd: RouterData = {\n            amountIn: new BN('0'),\n            amountOut: new BN('0'),\n            byAmountIn: by_amount_in,\n            routes: [],\n            insufficientLiquidity: true,\n            error: {\n              code: AggregatorServerErrorCode.NoRouter,\n              msg: ''\n            }\n          }\n          return handleRouterData(true, by_amount_in, uuid, fromToken, toToken, dd)\n        }\n\n        const routerParams: SwapInPoolsParams = {\n          from: fromToken.coin_type,\n          target: toToken.coin_type,\n          amount: new BN(amount),\n          byAmountIn: by_amount_in,\n          pools\n        }\n\n        console.log('🚀 ~ file: useFindBestRouting.ts:115 ~ findRouters ~ routerParams:', routerParams)\n\n        const res = await aggregatorSDK.swapInPools(routerParams)\n\n        console.log('🚀 ~ file: useFindBestRouting.ts:170 ~ swapInPools ~ res:', res)\n\n        if (!res || !res.routeData) {\n          return handleRouterData(true, by_amount_in, uuid, fromToken, toToken)\n        } else {\n          return handleRouterData(true, by_amount_in, uuid, fromToken, toToken, res.routeData)\n        }\n      } catch (error) {\n        console.log('🚀 ~ file: useFindBestRouting.ts:120 ~ swapInPools ~  error:', error)\n        const result: SwapRouterData = {\n          uuid,\n          byAmountIn: by_amount_in,\n          isDegrade: true\n        }\n\n        return result\n      }\n    }\n  }\n\n  const handleRouterData = (isDegrade: boolean, by_amount_in: boolean, uuid: string, fromToken: Token, toToken: Token, res?: RouterData) => {\n    console.log('🚀 ~ file: useSwap.ts:166 ~ handleRouterData ~ res:', {\n      isDegrade,\n      routerData: res\n    })\n    if (res) {\n      const isError = res.error !== undefined\n\n      const fromAmountUi = fromDecimalsAmountFix(res.amountIn.toString(), fromToken.decimals).toString()\n      const toAmountUi = fromDecimalsAmountFix(res.amountOut.toString(), toToken.decimals).toString()\n\n      const result: SwapRouterData = {\n        routerData: isError ? undefined : res,\n        fromAmountUi: isError ? (by_amount_in ? fromAmountUi : '') : fromAmountUi,\n        toAmountUi: isError ? (by_amount_in ? '' : toAmountUi) : toAmountUi,\n        uuid,\n        byAmountIn: by_amount_in,\n        isDegrade,\n        errorCode: res.error?.code\n      }\n\n      return result\n    } else {\n      const result: SwapRouterData = {\n        uuid,\n        byAmountIn: by_amount_in,\n        isDegrade\n      }\n\n      return result\n    }\n  }\n\n  return {\n    findBestRouters,\n    checkProvidersKeys\n  }\n}\n"],"names":["useFindBestRouting","aggregatorSDK","useClmmSDKStore","getSwapPoolAddress","useGetSwapPoolAddressList","deepbookV3Config","setDeepbookV3Config","providers","useWebConfigStore","isDisableDegrade","res","AggregatorServerErrorCode","checkProvidersKeys","providersKeys","tempProvidersKeys","item","config","nowTime","error","deep_fee_vault","toDecimalsAmount","findBestRouters","options","fromToken","toToken","amount","by_amount_in","uuid","routerParams","BN","handleRouterData","pools","dd","isDegrade","isError","fromAmountUi","fromDecimalsAmountFix","toAmountUi","_a"],"mappings":"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"}