import{u as Ee}from"./useTransaction-Bdgye9e1.js";import{u as Oe}from"./global-D9vHqz1e.js";import{a as Ne}from"./usePositionList-4IcszlUa.js";import{a as Ue,u as Ge}from"./useCurrentPos-s5NHcX_D.js";import{M as V}from"./msafe-oYBkW7LJ.js";import{v as de,f as j}from"./index-UNT2jrcH.js";import{u as Ve}from"./useAccountBalance-B2-ScmX9.js";import{aK as je,Q as Ke,a3 as We,r as y,a6 as $e,aS as Qe,a0 as ze,d as C,aL as le,be as z,bf as He,W as L,aU as Je,a5 as Xe,aV as re}from"./index-hlspwJoj.js";import{u as me}from"./useTokenBalance-hDBhZl2G.js";import{u as Ye}from"./useInsufficientBalanceToast-D_NJ41vQ.js";function lt(){const{clmmSdk:ue}=je(),{peripherySdk:H}=Ke(),{currentPosBaseInfo:e,posPoolsOriginalData:Ze,posPoolsRelatedData:Be,posRewardsData:pe}=Ne(),J=pe[e==null?void 0:e.posId],{getTokenAmountValue:X}=We(),{getCurrentPosBaseInfo:Ae}=Ue(),{currentPoolSqrtPrice:Y,tokenAmountA:g,tokenAmountB:x,isFixedDisplayTokenA:F,setIsFixedDisplayTokenA:Te,setTokenAmountA:v,setTokenAmountB:R,curPosContractPoolInfo:a,currentPosDetailTab:ke,isPosDetailRefresh:Z}=Ge(),[ge,K]=y.useState(!1),[xe,Se]=y.useState(""),[ye,fe]=y.useState(""),d=e==null?void 0:e.displayTokenA,l=e==null?void 0:e.displayTokenB,{slippage:E,mevProtect:we,maxCapForGas:be,transactionMode:_e,customGasPrice:De}=Oe(),{balanceInfo:h}=me(d),{balanceInfo:q}=me(l),Me=X(d==null?void 0:d.coin_type,g),Ce=X(l==null?void 0:l.coin_type,x),[W,$]=y.useState(""),B=y.useRef("");y.useEffect(()=>{console.log("ðŸš€ ~ usePosAdd ~ uuid:",W),B.current=W},[W]);const O=()=>{v(""),R(""),K(!1),$("")},N=y.useMemo(()=>{if(console.log("ðŸš€ ~ showTokenALock ~ curPosContractPoolInfo:",e,a),e&&a){const{lowerTick:t,upperTick:o}=e,i=a==null?void 0:a.current_tick_index;if(i!==void 0&&t!==void 0&&o!==void 0)return i>=t&&i<o?!1:i>=o?!0:!(i<t)}return!1},[a==null?void 0:a.current_tick_index,e]),U=y.useMemo(()=>{if(e&&a){const{lowerTick:t,upperTick:o}=e,i=a==null?void 0:a.current_tick_index;if(i!==void 0&&t!==void 0&&o!==void 0)return i>=t&&i<o||i>=o?!1:(i<t,!0)}return!1},[a==null?void 0:a.current_tick_index,e]),P=e!=null&&e.isReverse?U:N,I=e!=null&&e.isReverse?N:U,ee=t=>{console.log("ðŸš€ ~ usePosAdd ~ params:",t);const{amount:o,tokenA:i,tokenB:S,isTokenA:u,lowerTick:p,upperTick:T,curSqrtPrice:k,isReverse:r,roundUp:f}=t,w=new z(o);console.log("ðŸš€ ~ usePosAdd ~ coinAmount:",E,k,w.toString());const{coinAmountA:s,coinAmountB:n,tokenMaxA:b,tokenMaxB:_,liquidityAmount:A}=He.estLiquidityAndcoinAmountFromOneAmounts(p,T,w,u,f,C(E).toNumber(),new z(k));console.log("ðŸš€ ~ usePosAdd ~ coinAmountA:",s.toString()),console.log("ðŸš€ ~ usePosAdd ~ coinAmountB:",n.toString());const c=i.decimals,m=S.decimals;return{coinAmountAOrigin:s.toString(),coinAmountBOrigin:n.toString(),displayCoinAmountA:r?L(n.toString(),m):L(s.toString(),c),displayCoinAmountB:r?L(s.toString(),c):L(n.toString(),m),coinAmountA:L(s.toString(),c),coinAmountB:L(n.toString(),m),tokenMaxA:b.toString(),tokenMaxB:_.toString(),liquidityAmount:A.toString()}},te=$e((t,o,i)=>{var A,c;const S=o?(A=e==null?void 0:e.displayTokenA)==null?void 0:A.decimals:(c=e==null?void 0:e.displayTokenB)==null?void 0:c.decimals,u=Qe(t,S),p=e==null?void 0:e.tokenA,T=e==null?void 0:e.tokenB,k=e==null?void 0:e.lowerTick,r=e==null?void 0:e.upperTick,f=e==null?void 0:e.isReverse,w={amount:u,tokenA:p,tokenB:T,isTokenA:f?!o:o,lowerTick:k,upperTick:r,curSqrtPrice:Y,isReverse:f,roundUp:!0};console.log("ðŸš€ ~ debouncedPreAdd ~ params:",w);const{displayCoinAmountA:s,displayCoinAmountB:n,tokenMaxA:b,tokenMaxB:_}=ee(w);B.current===i?(Se(b),fe(_),o?R(n||""):v(s||"")):O(),K(!1)},500),G=()=>{if((g||x)&&Je(e)){console.log("ðŸš€ ~ reCalculateResult ~ currentPosBaseInfo:",e);const t=F?g:x;if(+t){const o=de();$(o),te(t,F,o)}}};y.useEffect(()=>{ke=="increase"&&Z&&G()},[Z]);const Fe=(t,o)=>{if(console.log("ðŸš€ ~ handleAmountChange ~ amount:",!t,+t,t),!t){O();return}if(Te(o),o?v(t):R(t),+t){K(!0);const i=de();$(i),console.log("ðŸš€ ~ handleAmountChange ~ params:",t),te(t,o,i)}else o?R(""):v("")},oe=async t=>{const{poolAddress:o,coinTypeA:i,coinTypeB:S,fixAmountA:u,amountA:p,amountB:T,lowerTick:k,upperTick:r,currentSqrtPrice:f,posType:w,rewarderCoinTypes:s,posIndex:n,posId:b,farmsPoolId:_}=t,A={coinTypeA:i,coinTypeB:S,amount_a:p,amount_b:T,pool_id:o,fix_amount_a:u,slippage:C(E).toNumber(),is_open:!n,tick_lower:k,tick_upper:r,collect_fee:!!n,rewarder_coin_types:s,pos_id:b||""},c={slippage:C(E).toNumber(),curSqrtPrice:new z(f)},m=await ue.Position.createAddLiquidityFixTokenPayload(A,c),M={action:n?V.IncreaseLiquidity:V.OpenAndAddLiquidity,txbParams:{parameter:A,gasEstimateArg:c}};return console.log("ðŸš€ ~ getClmmCreateAddData ~ msafeParams:",M,m),{tx:m,msafeParams:M}},ie=async t=>{const{poolAddress:o,coinTypeA:i,coinTypeB:S,fixAmountA:u,amountA:p,amountB:T,lowerTick:k,upperTick:r,currentSqrtPrice:f,posType:w,rewarderCoinTypes:s,posIndex:n,posId:b,farmsPoolId:_}=t;let A,c;if(b){const m={pool_id:_||"",coinTypeA:i,coinTypeB:S,position_nft_id:b,clmm_pool_id:o,amount_a:p,amount_b:T,collect_fee:!0,collect_rewarder:!1,fix_amount_a:u,clmm_rewarder_types:s};A=await H.Farms.addLiquidityFixCoinPayload(m),c={action:V.FarmingIncreaseLiquidity,txbParams:m}}else{const m={pool_id:_||"",coinTypeA:i,coinTypeB:S,clmm_pool_id:o,amount_a:p,amount_b:T,fix_amount_a:u,tick_lower:k,tick_upper:r};A=await H.Farms.openPositionAddLiquidityStakePaylod(m),c={action:V.FarmingOpenAndAddLiquidity,txbParams:m}}return console.log("ðŸš€ ~ getFarmsCreateAddData ~ msafeParams:",c,A),{tx:A,msafeParams:c}},se=t=>{const{posType:o}=t;return o==="clmm"?oe(t):ie(t)},{currentAccount:D}=ze(),Le=y.useMemo(()=>{const t={text:"Add More Liquidity",disabled:!1};return D!=null&&D.address?!+g&&!+x?(t.text="Enter an amount",t.disabled=!0,t):!P&&g&&C(g).gt((h==null?void 0:h.balanceFormat)||0)?(t.disabled=!0,t.text=`Insufficient ${le(d==null?void 0:d.symbol,10)} Balance`,t):!I&&x&&C(x).gt((q==null?void 0:q.balanceFormat)||0)?(t.disabled=!0,t.text=`Insufficient ${le(l==null?void 0:l.symbol,10)} Balance`,t):((!N&&!U&&(!+g||!+x)||(e==null?void 0:e.posType)=="burn")&&(t.disabled=!0),t):(t.text="Connect Wallet",t.disabled=!1,t)},[g,x,h,q,D==null?void 0:D.address]),{signAndExecuteTransaction:he}=Ee(),[qe,Q]=y.useState(!1),{fetchAccountBalance:ve}=Ve(),{showInsufficientBalanceToast:Re}=Ye();return{reCalculateResult:G,preAddLoading:ge,preAdd:ee,getAddTsPayload:se,displayTokenA:d,displayTokenB:l,tokenABalanceInfo:h,tokenBBalanceInfo:q,tokenAmountValueA:Me,tokenAmountValueB:Ce,handleAmountChange:Fe,resetInputAmount:O,btnStatusText:Le,toAdd:async()=>{var w;Q(!0);const t=F?g:x,o=F?d.decimals:l.decimals,i=C(t).mul(Xe.pow(10,o)).toString(),S=e!=null&&e.isReverse?!F:F;let u,p;const T=e==null?void 0:e.lowerTick,k=e==null?void 0:e.upperTick,r=a==null?void 0:a.current_tick_index;r!==void 0&&T&&k&&(r>=T&&r<=k?(u=S?i:xe,p=S?ye:i):r>k?(u=0,p=i):r<T&&(u=i,p=0)),console.log("ðŸš€ ~ toAdd ~ lowerTick:",T,k,r),console.log("ðŸš€ ~ toAdd ~ amount_a:",e,u,p);const f=(w=J||[])==null?void 0:w.reduce((s,n)=>(C(n==null?void 0:n.amount_owed).gt(0)&&s.push(n.coin_address),s),[]);console.log("ðŸš€ ~ toAdd ~ rewarderCoinTypes:",J,f);try{const s={poolAddress:e==null?void 0:e.clmmPool,coinTypeA:e==null?void 0:e.coinTypeA,coinTypeB:e==null?void 0:e.coinTypeB,amountA:u,amountB:p,fixAmountA:S,lowerTick:e==null?void 0:e.lowerTick,upperTick:e==null?void 0:e.upperTick,currentSqrtPrice:Y,posType:e==null?void 0:e.posType,rewarderCoinTypes:f,posIndex:e==null?void 0:e.index,posId:(e==null?void 0:e.posType)=="farms"?e==null?void 0:e.id:e==null?void 0:e.posId};(e==null?void 0:e.posType)=="farms"&&(s.farmsPoolId=e==null?void 0:e.farmsPool),console.log("ðŸš€ ~ toAdd ~ params:",s);const{tx:n,msafeParams:b}=await se(s),_=await he(n,{getShowInfo:(A,c)=>{const m="Add "+[j(g,d==null?void 0:d.symbol),j(x,l==null?void 0:l.symbol)].filter(Boolean).join(" and "),M={modalDescriptionText:m,toastTitleText:m};if(A==="success"){let ne=g,ae=x;c&&(ne=re(c,d)||g,ae=re(c,l)||x);const ce="Add "+[j(ne,d==null?void 0:d.symbol),j(ae,l==null?void 0:l.symbol)].filter(Boolean).join(" and ");M.toastDescriptionContent=ce,M.modalDescriptionText=ce,M.toastTitleText="Supplied Successful"}return M}},{useMev:we,useFastMode:_e==="Fast Mode",maxCapForGas:be,customGasPrice:De,msafeParams:b});console.log("ðŸš€ ~ toClaim ~ res:",_),_?(ve(),O(),Ae(D==null?void 0:D.address,e==null?void 0:e.id,!0)):G(),Q(!1)}catch(s){console.log("ðŸš€ ~ toClaim ~ error:",s),G(),Re(String(s)),Q(!1)}},isAddLoading:qe,showTokenALock:N,showTokenBLock:U,showDisplayTokenALock:P,showDisplayTokenBLock:I,getClmmCreateAddData:oe,getFarmsCreateAddData:ie}}export{lt as u};
